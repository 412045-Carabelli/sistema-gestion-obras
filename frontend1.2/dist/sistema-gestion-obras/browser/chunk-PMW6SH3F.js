import{a as oe,c as le,d as ae}from"./chunk-XV6SL7QC.js";import{a as se}from"./chunk-BB2Q7CPB.js";import{a as ne,b as re}from"./chunk-R4Q2BO3D.js";import"./chunk-YHK2U7VT.js";import{a as G,b as te,c as ie}from"./chunk-4BI7NTQR.js";import{i as Q,j as X,k as Y,l as Z}from"./chunk-WA2J6DLI.js";import"./chunk-XZVY7D3K.js";import"./chunk-X5MSVAUN.js";import{b as $,c as ee}from"./chunk-WXQODJCJ.js";import"./chunk-BBQRPO7P.js";import{f as J,g as H}from"./chunk-V6H4TXMQ.js";import{l as K}from"./chunk-VHDVROXF.js";import"./chunk-N52SNE3S.js";import"./chunk-F2X3VGZZ.js";import{b as N,e as B,h as j,o as q,s as U}from"./chunk-IZVSUXNV.js";import"./chunk-LSHC46HD.js";import"./chunk-4BJQ3EOG.js";import{c as z}from"./chunk-MLMYHGGX.js";import"./chunk-42DWQLJE.js";import"./chunk-XQ2VYUTW.js";import"./chunk-MX3PZFJO.js";import"./chunk-LXJ5KELJ.js";import"./chunk-CV2ZWZQE.js";import{A as R,E as x,I as W,l as k,p as A,r as L}from"./chunk-G4GGURKU.js";import"./chunk-5GYOOLE2.js";import{$b as P,Bb as h,Gb as m,Hb as d,Ma as c,Ra as w,Rb as s,Sb as v,Tb as O,Vb as b,Wb as g,Xb as C,Ya as M,Yb as V,Zb as E,aa as p,ba as u,cb as f,hc as F,jc as I,lb as _,ob as T,qb as S,vb as l,wb as r,xb as y,z as D}from"./chunk-HE3ZW6WA.js";var de=()=>({width:"450px"}),me=()=>({label:"Proveedor",value:"PROVEEDOR"}),pe=()=>({label:"Cliente",value:"CLIENTE"}),ue=(a,n)=>[a,n],_e=()=>({width:"400px"});function be(a,n){a&1&&(l(0,"tr")(1,"th",27),s(2," Tipo "),y(3,"p-sortIcon",28),r(),l(4,"th"),s(5,"Observaci\xF3n"),r(),l(6,"th",29),s(7," Fecha "),y(8,"p-sortIcon",30),r(),l(9,"th",31),s(10," Archivo "),y(11,"p-sortIcon",32),r(),l(12,"th"),s(13,"Acciones"),r()())}function ge(a,n){if(a&1){let e=h();l(0,"tr")(1,"td"),s(2),r(),l(3,"td"),s(4),r(),l(5,"td"),s(6),F(7,"date"),r(),l(8,"td")(9,"span",33),s(10),r()(),l(11,"td",34)(12,"p-button",35),m("onClick",function(){let i=p(e).$implicit,o=d();return u(o.descargarDocumento(i))}),r(),l(13,"p-button",36),m("onClick",function(){let i=p(e).$implicit,o=d();return u(o.eliminarDocumento(i))}),r()()()}if(a&2){let e,t=n.$implicit;c(2),v((e=t.tipo_documento)!==null&&e!==void 0?e:"\u2014"),c(2),v(t.observacion||"\u2014"),c(2),v(I(7,5,t.fecha,"dd/MM/yyyy")),c(3),_("title",t.nombre_archivo),c(),O(" ",t.nombre_archivo," ")}}function Ce(a,n){if(a&1){let e=h();l(0,"div",14)(1,"label",12),s(2," Proveedor "),r(),l(3,"p-autoComplete",37),C("ngModelChange",function(i){p(e);let o=d();return g(o.selectedProveedor,i)||(o.selectedProveedor=i),u(i)}),m("completeMethod",function(i){p(e);let o=d();return u(o.filtrarProveedores(i))})("onSelect",function(){p(e);let i=d();return u(i.cargarDatos())}),r()()}if(a&2){let e=d();c(3),b("ngModel",e.selectedProveedor),_("suggestions",e.filteredProveedores)("dropdown",!0)}}function fe(a,n){if(a&1){let e=h();l(0,"div",14)(1,"label",12),s(2," Cliente "),r(),l(3,"p-autoComplete",38),C("ngModelChange",function(i){p(e);let o=d();return g(o.selectedCliente,i)||(o.selectedCliente=i),u(i)}),m("completeMethod",function(i){p(e);let o=d();return u(o.filtrarClientes(i))})("onSelect",function(){p(e);let i=d();return u(i.cargarDatos())}),r()()}if(a&2){let e=d();c(3),b("ngModel",e.selectedCliente),_("suggestions",e.filteredClientes)("dropdown",!0)}}function he(a,n){if(a&1){let e=h();l(0,"div",40)(1,"span",41),s(2),r(),l(3,"button",42),m("click",function(){let i=p(e).index,o=d(2);return u(o.quitarArchivo(i))}),s(4," \xD7 "),r()()}if(a&2){let e=n.$implicit;c(2),v(e.name)}}function ve(a,n){if(a&1&&(l(0,"div",19),f(1,he,5,1,"div",39),r()),a&2){let e=d();c(),_("ngForOf",e.selectedFiles)}}function ye(a,n){if(a&1){let e=h();l(0,"p-button",25),m("onClick",function(){p(e);let i=d();return u(i.modalVisible=!1)}),r(),l(1,"p-button",43),m("onClick",function(){p(e);let i=d();return u(i.guardarDocumento())}),r()}}var ce=class a{constructor(n,e){this.documentosService=n;this.messageService=e}obraId;proveedores=[];clientes=[];documentos=[];tiposDocumento=[];loading=!0;modalVisible=!1;selectedTipo="FACTURA";observacion="";selectedFiles=[];confirmModalVisible=!1;docAEliminar=null;tipoEntidad="CLIENTE";selectedProveedor=null;selectedCliente=null;filteredProveedores=[];filteredClientes=[];ngOnInit(){this.loading=!0,D({tipos:this.documentosService.getTiposDocumento()}).subscribe({next:({tipos:n})=>{this.tiposDocumento=n?.map(e=>({label:e.label??e.nombre??e.name??e.value,value:e.value??e.name??e.id??e.label}))??[],this.loading=!1},error:()=>{this.tiposDocumento=[],this.loading=!1}})}filtrarProveedores(n){let e=n.query.toLowerCase();this.filteredProveedores=this.proveedores.filter(t=>t.nombre.toLowerCase().includes(e))}filtrarClientes(n){let e=n.query.toLowerCase();this.filteredClientes=this.clientes.filter(t=>t.nombre.toLowerCase().includes(e))}cargarDatos(){this.loading=!0;let n=this.tipoEntidad==="PROVEEDOR"&&this.selectedProveedor?"PROVEEDOR":this.tipoEntidad==="CLIENTE"&&this.selectedCliente?"CLIENTE":null,e=this.tipoEntidad==="PROVEEDOR"&&this.selectedProveedor?this.selectedProveedor.id:this.tipoEntidad==="CLIENTE"&&this.selectedCliente?this.selectedCliente.id:null;if(!n||!e){this.documentos=[],this.loading=!1;return}this.documentosService.getDocumentosPorAsociado(n,e).subscribe({next:t=>{this.documentos=t,this.loading=!1},error:()=>{this.documentos=[],this.loading=!1}})}abrirModal(){this.modalVisible=!0,this.observacion="",this.selectedFiles=[],this.tipoEntidad==="CLIENTE"&&this.clientes&&this.clientes.length===1&&(this.selectedCliente=this.clientes[0])}onFileSelected(n){let e=n?.currentFiles??n?.files??[];this.selectedFiles=Array.isArray(e)?[...e]:Array.from(e)}quitarArchivo(n){this.selectedFiles.splice(n,1)}guardarDocumento(){if(!this.selectedFiles.length||!this.selectedTipo){this.messageService.add({severity:"warn",summary:"Datos incompletos",detail:"Seleccion\xE1 un tipo y un archivo."});return}let n,e;if(this.tipoEntidad==="PROVEEDOR"){if(!this.selectedProveedor){this.messageService.add({severity:"warn",summary:"Falta proveedor",detail:"Seleccion\xE1 un proveedor para asociar el documento."});return}n=this.selectedProveedor.id,e="PROVEEDOR"}else{if(!this.selectedCliente){this.messageService.add({severity:"warn",summary:"Falta cliente",detail:"Seleccion\xE1 un cliente para asociar el documento."});return}n=this.selectedCliente.id,e="CLIENTE"}console.log("\u{1F680} Subir documento",{obraId:this.obraId,selectedTipo:this.selectedTipo,idAsociado:n,tipoAsociado:e,archivos:this.selectedFiles.map(i=>i.name)});let t=this.selectedFiles.map(i=>this.documentosService.uploadDocumentoFlexible(this.obraId,this.selectedTipo,this.observacion??"",i,n,e));D(t).subscribe({next:i=>{this.documentos=[...this.documentos,...i],this.modalVisible=!1,this.selectedFiles=[],this.observacion="",this.messageService.add({severity:"success",summary:"Documentos subidos",detail:`${i.length} archivo(s) agregados`})},error:()=>{this.messageService.add({severity:"error",summary:"Error",detail:"No se pudieron subir los documentos."})}})}eliminarDocumento(n){this.docAEliminar=n,this.confirmModalVisible=!0}cancelarEliminacion(){this.docAEliminar=null,this.confirmModalVisible=!1}confirmarEliminacion(){this.docAEliminar&&this.documentosService.deleteDocumento(this.docAEliminar.id_documento).subscribe({next:()=>{this.documentos=this.documentos.filter(n=>n.id_documento!==this.docAEliminar?.id_documento),this.messageService.add({severity:"success",summary:"Eliminado",detail:"Documento eliminado correctamente"}),this.docAEliminar=null,this.confirmModalVisible=!1},error:()=>{this.messageService.add({severity:"error",summary:"Error",detail:"No se pudo eliminar el documento."})}})}descargarDocumento(n){this.documentosService.downloadDocumento(n.id_documento).subscribe({next:e=>{let t=new Blob([e]),i=window.URL.createObjectURL(t),o=document.createElement("a");o.href=i,o.download=n.nombre_archivo||"documento",o.click(),window.URL.revokeObjectURL(i),this.messageService.add({severity:"success",summary:"Descarga iniciada",detail:n.nombre_archivo})},error:()=>{this.messageService.add({severity:"error",summary:"Error",detail:"No se pudo descargar el documento."})}})}static \u0275fac=function(e){return new(e||a)(w(se),w(x))};static \u0275cmp=M({type:a,selectors:[["app-obra-documentos"]],inputs:{obraId:"obraId",proveedores:"proveedores",clientes:"clientes"},features:[V([x,R])],decls:46,vars:35,consts:[["position","bottom-right"],[1,"p-4","space-y-4"],[1,"flex","justify-between","items-center","mb-3"],[1,"text-xl","font-semibold","text-gray-800"],["icon","pi pi-plus","label","Nuevo Documento","styleClass","p-button-primary",3,"onClick"],["responsiveLayout","scroll","sortField","fecha",1,"p-datatable-sm","border","border-gray-200","rounded-lg","overflow-hidden",3,"paginator","rows","sortOrder","value"],["pTemplate","header"],["pTemplate","body"],["header","Nuevo Documento",3,"visibleChange","visible","draggable","modal","resizable"],[1,"flex","flex-col","gap-4","mb-4"],[1,"grid","grid-cols-5","gap-3"],[1,"col-span-2"],[1,"block","text-sm","font-medium","mb-1","text-gray-700"],["placeholder","Seleccionar tipo de entidad","styleClass","w-full",3,"ngModelChange","onChange","ngModel","options"],[1,"col-span-3"],[1,"space-y-4"],["optionLabel","label","optionValue","value","appendTo","body","placeholder","Seleccionar tipo de documento","styleClass","w-full",3,"ngModelChange","ngModel","options"],["pInputText","","placeholder","Ej. Factura inicial","type","text",1,"w-full",3,"ngModelChange","ngModel"],["mode","basic","chooseLabel","Subir archivo","chooseIcon","pi pi-upload","accept",".pdf,.jpg,.jpeg,.png",1,"flex","flex-start",3,"onSelect","auto","multiple"],[1,"mt-2","space-y-1"],["pTemplate","footer"],["header","Confirmar eliminaci\xF3n",3,"visibleChange","visible","closable","draggable","modal","resizable"],[1,"text-gray-800"],[1,"text-sm","text-gray-500"],[1,"flex","justify-end","gap-2"],["icon","pi pi-times","label","Cancelar","styleClass","p-button-text",3,"onClick"],["icon","pi pi-check","label","Eliminar","styleClass","p-button-danger",3,"onClick"],["pSortableColumn","tipo_documento.nombre"],["field","tipo_documento.nombre"],["pSortableColumn","fecha"],["field","fecha"],["pSortableColumn","nombre_archivo"],["field","nombre_archivo"],[1,"truncate-text",3,"title"],[1,"space-x-2"],["icon","pi pi-download","pTooltip","Descargar","styleClass","p-button-sm p-button-secondary","tooltipPosition","top",3,"onClick"],["icon","pi pi-trash","pTooltip","Eliminar","styleClass","p-button-danger p-button-sm","tooltipPosition","top",3,"onClick"],["field","nombre","placeholder","Buscar proveedor","styleClass","w-full",3,"ngModelChange","completeMethod","onSelect","ngModel","suggestions","dropdown"],["field","nombre","placeholder","Buscar cliente","styleClass","w-full",3,"ngModelChange","completeMethod","onSelect","ngModel","suggestions","dropdown"],["class","flex items-center gap-2 text-sm text-gray-700 bg-gray-50 p-2 rounded",4,"ngFor","ngForOf"],[1,"flex","items-center","gap-2","text-sm","text-gray-700","bg-gray-50","p-2","rounded"],[1,"truncate"],["type","button",1,"text-red-500","hover:text-red-700",3,"click"],["icon","pi pi-check","label","Guardar","styleClass","p-button-primary",3,"onClick"]],template:function(e,t){e&1&&(y(0,"p-toast",0)(1,"p-confirmDialog"),l(2,"div",1)(3,"div",2)(4,"h2",3),s(5,"Documentos"),r(),l(6,"p-button",4),m("onClick",function(){return t.abrirModal()}),r()(),l(7,"p-table",5),f(8,be,14,0,"ng-template",6)(9,ge,14,8,"ng-template",7),r(),l(10,"p-dialog",8),C("visibleChange",function(o){return g(t.modalVisible,o)||(t.modalVisible=o),o}),l(11,"div",9)(12,"div",10)(13,"div",11)(14,"label",12),s(15," Asociar documento a "),r(),l(16,"p-select",13),C("ngModelChange",function(o){return g(t.tipoEntidad,o)||(t.tipoEntidad=o),o}),m("onChange",function(){return t.cargarDatos()}),r()(),f(17,Ce,4,3,"div",14)(18,fe,4,3,"div",14),r()(),l(19,"div",15)(20,"div")(21,"label",12),s(22,"Tipo"),r(),l(23,"p-select",16),C("ngModelChange",function(o){return g(t.selectedTipo,o)||(t.selectedTipo=o),o}),r()(),l(24,"div")(25,"label",12),s(26,"Observaci\xF3n"),r(),l(27,"input",17),C("ngModelChange",function(o){return g(t.observacion,o)||(t.observacion=o),o}),r()(),l(28,"div")(29,"label",12),s(30,"Archivo"),r(),l(31,"p-fileUpload",18),m("onSelect",function(o){return t.onFileSelected(o)}),r(),f(32,ve,2,1,"div",19),r()(),f(33,ye,2,0,"ng-template",20),r(),l(34,"p-dialog",21),C("visibleChange",function(o){return g(t.confirmModalVisible,o)||(t.confirmModalVisible=o),o}),l(35,"div",15)(36,"p",22),s(37," \xBFEst\xE1s seguro de que quer\xE9s eliminar el documento "),l(38,"strong"),s(39),r(),s(40,"? "),r(),l(41,"p",23),s(42,"Esta acci\xF3n no se puede deshacer."),r(),l(43,"div",24)(44,"p-button",25),m("onClick",function(){return t.cancelarEliminacion()}),r(),l(45,"p-button",26),m("onClick",function(){return t.confirmarEliminacion()}),r()()()()()),e&2&&(c(7),_("paginator",!0)("rows",5)("sortOrder",-1)("value",t.documentos),c(3),T(E(28,de)),b("visible",t.modalVisible),_("draggable",!1)("modal",!0)("resizable",!1),c(6),b("ngModel",t.tipoEntidad),_("options",P(31,ue,E(29,me),E(30,pe))),c(),S(t.tipoEntidad==="PROVEEDOR"?17:-1),c(),S(t.tipoEntidad==="CLIENTE"?18:-1),c(5),b("ngModel",t.selectedTipo),_("options",t.tiposDocumento),c(4),b("ngModel",t.observacion),c(4),_("auto",!1)("multiple",!0),c(),S(t.selectedFiles.length?32:-1),c(2),T(E(34,_e)),b("visible",t.confirmModalVisible),_("closable",!1)("draggable",!1)("modal",!0)("resizable",!1),c(5),v(t.docAEliminar==null?null:t.docAEliminar.nombre_archivo))},dependencies:[L,k,A,Z,Q,W,X,Y,H,J,G,ie,te,ee,$,q,N,B,j,U,oe,re,ne,z,K,ae,le],styles:[".truncate-text[_ngcontent-%COMP%]{display:inline-block;max-width:180px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;vertical-align:middle}"]})};export{ce as ObraDocumentosComponent};
