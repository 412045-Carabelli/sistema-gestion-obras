<div class="mt-4 rounded-lg overflow-hidden shadow-sm">
  <p-table
    [tableStyle]="{ 'min-width': '100%' }"
    [value]="costos.controls"
    class="w-full text-sm"
  >
    <!-- CABECERA -->
    <ng-template pTemplate="header">
      <tr>
        <th class="px-3 py-2 text-left w-20">Item</th>
        <th class="px-3 py-2 text-left w-48">Proveedor</th>
        <th class="px-3 py-2 text-left w-64">Descripción</th>
        <th class="px-3 py-2 text-right w-20">Cantidad</th>
        <th class="px-3 py-2 text-right w-20">Uni. Med.</th>
        <th class="px-3 py-2 text-right w-32">Precio Unitario</th>
        <th class="px-3 py-2 text-right w-28">Beneficio (%)</th>
        <th class="px-3 py-2 text-right w-32">Total</th>
        <th class="px-3 py-2 text-center w-24">Acciones</th>
      </tr>
    </ng-template>

    <!-- CUERPO -->
    <ng-template let-fila let-rowIndex="rowIndex" pTemplate="body">
      <tr [formGroup]="costos.at(rowIndex)" class="border-t">
        <!-- Item -->
        <td class="px-2 py-1 w-20">
          @if (modoEdicion) {
            <input pInputText formControlName="item_numero" placeholder="Ej. 1.1" class="w-full"/>
          } @else {
            {{ getItemNumeroDisplay(rowIndex) }}
          }
        </td>
        <!-- Proveedor -->
        <td class="px-2 py-1 w-48">
          @if (modoEdicion) {
            <p-autoComplete
              formControlName="id_proveedor"
              [suggestions]="filteredProveedores"
              [dropdown]="true"
              [showClear]="true"
              optionLabel="nombre"
              field="nombre"
              placeholder="Seleccionar"
              appendTo="body"
              class="w-full"
              inputStyleClass="w-full"
              (completeMethod)="filtrarProveedores($event)"
              (onSelect)="seleccionarProveedor(rowIndex, $event.value ?? $event)"
              (onClear)="limpiarProveedor(rowIndex)"
              (onDropdownClick)="filtrarProveedores({ query: '' })"
            ></p-autoComplete>
          } @else {
            {{ getProveedorNombre(costos.at(rowIndex).get('id_proveedor')?.value) }}
          }
        </td>

        <!-- Descripción -->
        <td class="px-2 py-1 w-64">
          @if (modoEdicion) {
            <input pInputText formControlName="descripcion" placeholder="Descripción" class="w-full"/>
          } @else {
            {{ costos.at(rowIndex).get('descripcion')?.value }}
          }
        </td>

        <!-- Cantidad -->
        <td class="px-2 py-1 text-right w-18">
          @if (modoEdicion) {
            <input type="number" pInputText formControlName="cantidad" class="w-full text-right"/>
          } @else {
            {{ costos.at(rowIndex).get('cantidad')?.value }}
          }
        </td>

        <!-- Unidad -->
        <td class="px-2 py-1 w-26">
          @if (modoEdicion) {
            <input pInputText formControlName="unidad" placeholder="Ej. m2" class="w-full"/>
          } @else {
            {{ costos.at(rowIndex).get('unidad')?.value }}
          }
        </td>

        <!-- Precio Unitario -->
        <td class="px-2 py-1 text-right w-32">
          @if (modoEdicion) {
            <p-inputNumber
              formControlName="precio_unitario"
              mode="decimal"
              locale="es-AR"
              [useGrouping]="true"
              [minFractionDigits]="2"
              [maxFractionDigits]="2"
              inputStyleClass="w-full text-right"
              [min]="0">
            </p-inputNumber>
          } @else {
            {{ costos.at(rowIndex).get('precio_unitario')?.value | currency:'ARS' }}
          }
        </td>

        <!-- Beneficio -->
        <td class="px-2 py-1 text-right w-28">
          @if (modoEdicion) {
            <input type="number" pInputText formControlName="beneficio" class="w-full text-right"/>
          } @else {
            {{ costos.at(rowIndex).get('beneficio')?.value ?? 0 }}%
          }
        </td>

        <!-- Total -->
        <td class="px-2 py-1 text-right font-semibold text-green-700 w-32">
          {{ costos.at(rowIndex).get('total')?.value | currency:'ARS' }}
        </td>
        <td class="px-2 py-1 text-center w-24">
          @if (modoEdicion) {
            <p-button
              icon="pi pi-trash"
              severity="danger"
              styleClass="p-button-text p-button-sm"
              type="button"
              (onClick)="eliminarFila(rowIndex)">
            </p-button>
          } @else {
            <span class="text-gray-400 text-xs">-</span>
          }
        </td>
      </tr>
    </ng-template>

    <!-- PIE DE TABLA -->
    <ng-template pTemplate="footer">
      <tr class="font-semibold border-t bg-gray-50">
        <td class="text-right px-3 py-2" colspan="8">TOTAL GENERAL:</td>
        <td class="text-right px-3 py-2 text-green-700">
          {{ calcularTotalGeneral() | currency:'ARS' }}
        </td>
      </tr>
    </ng-template>
  </p-table>
</div>
