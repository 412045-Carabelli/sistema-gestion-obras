<p-toast position="bottom-right"></p-toast>
<p-confirmDialog></p-confirmDialog>

<div class="p-4 space-y-5">
  <!-- Header -->
  <div class="flex justify-between items-center flex-wrap gap-3">
    <div>
      <h2 class="text-2xl font-bold text-gray-900">Presupuesto</h2>
      <p class="text-gray-500 text-sm mt-1">
        Matriz de costos detallada de la obra
      </p>
    </div>

    <div class="flex gap-5 items-center">
      <p-button
        (onClick)="exportMenu.toggle($event)"
        icon="pi pi-file-pdf"
        label="Exportar PDF"
        styleClass="p-button-md p-button-primary"
      ></p-button>
      <p-menu #exportMenu [popup]="true" [model]="exportOptions"></p-menu>
    </div>
  </div>
  <!-- Memoria descriptiva y formulario rapido -->
  <div class="grid grid-cols-1 xl:grid-cols-2 gap-5">
    <!-- Formulario rapido para agregar costos -->
    <div class="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden">
      <div class="flex items-center justify-between px-4 py-3 border-b border-gray-100">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-lg bg-blue-50 text-blue-600 flex items-center justify-center">
            <i class="pi pi-plus text-lg"></i>
          </div>
          <div>
            <p class="text-sm font-semibold text-gray-900 leading-none">Agregar costo</p>
            <p class="text-xs text-gray-500 leading-none">Completa los campos y sumalo a la matriz</p>
          </div>
        </div>
        <div class="hidden md:flex items-center gap-2 text-xs text-gray-500">
          <i class="pi pi-info-circle text-gray-400"></i>
          <span>Usa el beneficio global si esta habilitado.</span>
        </div>
      </div>

      <div class="px-4 py-4 grid grid-cols-1 md:grid-cols-2 gap-3">
        <div class="flex flex-col gap-1">
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
            <div class="flex flex-col gap-1">
              <label class="text-xs font-medium text-gray-600 min-h-[16px]">Item</label>
              <input
                [(ngModel)]="nuevoCosto.item_numero"
                class="w-full"
                pInputText
                placeholder="Ej: 1.1"
                type="text"
              />
            </div>
            <div class="flex flex-col gap-1 sm:col-span-2">
              <label class="text-xs font-medium text-gray-600 min-h-[16px]">Proveedor</label>
              <p-autoComplete
                [(ngModel)]="nuevoCostoProveedor"
                [suggestions]="filteredProveedores"
                [dropdown]="true"
                [showClear]="true"
                optionLabel="nombre"
                field="nombre"
                placeholder="Selecciona proveedor"
                class="w-full"
                inputStyleClass="w-full"
                appendTo="body"
                fluid
                (completeMethod)="filtrarProveedores($event)"
                (onSelect)="seleccionarProveedorNuevo($event.value ?? $event)"
                (onClear)="limpiarProveedorNuevo()"
                (onDropdownClick)="filtrarProveedores({ query: '' })"
              ></p-autoComplete>
            </div>
          </div>
        </div>

        <div class="flex flex-col gap-1 md:col-start-2 md:row-start-1">
          <label class="text-xs font-medium text-gray-600 min-h-[16px]">Descripcion</label>
          <input
            [(ngModel)]="nuevoCosto.descripcion"
            class="w-full"
            pInputText
            placeholder="Ej: Mano de obra, materiales..."
            type="text"
          />
        </div>

        <div class="flex flex-col gap-1">
          <label class="text-xs font-medium text-gray-600 min-h-[16px]">Cantidad y unidad</label>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <input
              [(ngModel)]="nuevoCosto.cantidad"
              class="w-full text-right"
              min="0"
              pInputText
              placeholder="Cantidad"
              type="number"
            />
            <input
              [(ngModel)]="nuevoCosto.unidad"
              class="w-full"
              pInputText
              placeholder="Unidad (ej: m2)"
              type="text"
            />
          </div>
        </div>

        <div class="flex flex-col gap-1 md:col-start-2 md:row-start-2">
          <label class="text-xs font-medium text-gray-600 min-h-[16px]">Precio unitario</label>
          <p-inputNumber
            [(ngModel)]="nuevoCosto.precio_unitario"
            mode="decimal"
            locale="es-AR"
            [useGrouping]="true"
            [minFractionDigits]="2"
            [maxFractionDigits]="2"
            inputStyleClass="w-full text-right"
            placeholder="0"
            [min]="0">
          </p-inputNumber>
        </div>

        <div class="flex flex-col gap-1 md:col-span-2">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div class="flex flex-col gap-1">
              <label class="text-xs font-medium text-gray-600 min-h-[16px]">Tipo de costo</label>
              <p-select
                [(ngModel)]="nuevoCosto.tipo_costo"
                [options]="getTipoCostoOptions()"
                optionLabel="label"
                optionValue="value"
                placeholder="Selecciona"
                appendTo="body"
                (onChange)="onTipoCostoNuevoChange($event.value)"
                styleClass="w-full"
              ></p-select>
            </div>
            <div class="flex flex-col gap-1">
              <label class="text-xs font-medium text-gray-600 min-h-[16px]">Beneficio (%)</label>
              <input
                [(ngModel)]="nuevoCosto.beneficio"
                [disabled]="usarBeneficioGlobal && nuevoCosto.tipo_costo !== 'ADICIONAL'"
                class="w-full text-right"
                min="0"
                pInputText
                placeholder="Beneficio %"
                type="number"
              />
            </div>
          </div>
        </div>

        <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-3 items-end">
          <div class="flex flex-col gap-1">
            <label class="text-xs font-medium text-gray-600 min-h-[16px]">Subtotal</label>
            <input
              [ngModel]="calcularNuevoCostoSubtotal() | currency:'ARS'"
              class="w-full text-right font-medium text-gray-700"
              pInputText
              type="text"
              disabled
            />
          </div>

          <div class="flex flex-col gap-1">
            <label class="text-xs font-medium text-gray-600 min-h-[16px]">Total con beneficio</label>
            <input
              [ngModel]="calcularNuevoCostoTotal() | currency:'ARS'"
              class="w-full text-right font-semibold text-emerald-700"
              pInputText
              type="text"
              disabled
            />
          </div>
        </div>

        <div class="flex justify-end md:col-span-2">
          <p-button
            (onClick)="agregarCosto()"
            label="Agregar costo"
            icon="pi pi-plus"
            styleClass="p-button-sm p-button-primary h-10"
            [disabled]="estaSelladaCotizacion() && nuevoCosto.tipo_costo !== 'ADICIONAL'">
          </p-button>
        </div>
      </div>
    </div>

    <!-- Memoria descriptiva -->
    <div class="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden">
      <div class="flex items-center justify-between px-4 py-3 border-b border-gray-100">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-lg bg-blue-50 text-blue-600 flex items-center justify-center">
            <i class="pi pi-align-left text-lg"></i>
          </div>
          <div class="flex flex-col gap-1">
            <h3 class="text-sm font-semibold text-gray-900 leading-none">Memoria descriptiva</h3>
            <p class="text-xs text-gray-500 leading-none">Resume el alcance y los detalles clave de la obra</p>
          </div>
        </div>
        @if (!memoriaEditando) {
          <p-button
            label="Editar"
            icon="pi pi-pencil"
            styleClass="p-button-text p-button-sm"
            (onClick)="iniciarEdicionMemoria()"
          ></p-button>
        }
      </div>
      <div class="p-6">
      @if (memoriaEditando) {
        <div class="space-y-3">
          <p-editor [(ngModel)]="memoriaDraft" styleClass="w-full"></p-editor>
          <div class="flex justify-end gap-2">
            <p-button
              label="Cancelar"
              icon="pi pi-times"
              styleClass="p-button-text p-button-sm"
              (onClick)="cancelarEdicionMemoria()"
              [disabled]="guardandoMemoria"
            ></p-button>
            <p-button
              label="Guardar"
              icon="pi pi-check"
              styleClass="p-button-primary p-button-sm"
              (onClick)="guardarMemoriaDescriptiva()"
              [loading]="guardandoMemoria"
            ></p-button>
          </div>
        </div>
      } @else if (obra?.memoria_descriptiva?.trim()) {
        <div class="p-4 rounded-lg bg-blue-50 border border-blue-200 text-gray-800 memoria-view">
          <div
            #memoriaBody
            class="memoria-body"
            [ngClass]="{ 'memoria-collapsed': !memoriaExpandida }"
            [innerHTML]="obra.memoria_descriptiva"
          ></div>
          @if (memoriaOverflow) {
            <button
              type="button"
              class="text-sm text-blue-700 font-semibold mt-3 cursor-pointer"
              (click)="toggleMemoria()"
            >
              {{ memoriaExpandida ? 'Ver menos' : 'Ver mas' }}
            </button>
          }
        </div>
      } @else {
        <div class="p-4 rounded-lg bg-blue-50 border border-blue-200 text-gray-700">
          Sin memoria descriptiva registrada
        </div>
      }
      </div>
    </div>
  </div>

  <!-- Tabla de costos -->
  @if (costosFiltrados.length > 0) {
    <p-table
      [value]="costosFiltrados"
      class="text-sm p-datatable-sm border border-gray-200 rounded-lg overflow-hidden"
      responsiveLayout="scroll"
    >
      <!-- Encabezado -->
      <ng-template pTemplate="header">
        <tr class="bg-gray-50 text-gray-700">
          <th class="text-left px-3 py-2 font-semibold">Item</th>
          <th class="text-left px-3 py-2 font-semibold">Proveedor</th>
          <th class="text-left px-3 py-2 font-semibold">Descripcion</th>
          <th class="text-left px-3 py-2 font-semibold">Cantidad</th>
          <th class="text-left px-3 py-2 font-semibold">Precio Unit.</th>
          <th class="text-left px-3 py-2 font-semibold">Beneficio (%)</th>
          <th class="text-left px-3 py-2 font-semibold">Subtotal</th>
          <th class="text-left px-3 py-2 font-semibold">Total</th>
        </tr>
      </ng-template>

      <!-- Filas -->
      <ng-template let-c let-rowIndex="rowIndex" pTemplate="body">
        <tr
          [ngClass]="{
            'bg-yellow-200 hover:bg-yellow-300': esAdicional(c),
            'bg-white': !esAdicional(c) && rowIndex % 2 === 0,
            'bg-gray-50': !esAdicional(c) && rowIndex % 2 !== 0,
            'hover:bg-emerald-50': !esAdicional(c)
          }"
          class="cursor-pointer transition-colors"
          (click)="!c.enEdicion && abrirDetalleCosto(c)"
        >
          <td class="px-3 py-2">
            @if (c.enEdicion) {
              <input
                [(ngModel)]="c.item_numero"
                class="w-full"
                pInputText
                type="text"
                (click)="$event.stopPropagation()"
              />
            } @else {
              <span class="text-gray-700">{{ getItemNumeroDisplay(c, rowIndex) }}</span>
            }
          </td>
            <td class="px-3 py-2">
              <p-autoComplete
                [(ngModel)]="c.proveedor"
                [disabled]="!c.enEdicion"
                [suggestions]="filteredProveedores"
                [dropdown]="true"
                [showClear]="true"
                optionLabel="nombre"
                optionValue="id"
                field="nombre"
                placeholder="Proveedor"
                class="w-full"
                inputStyleClass="w-full"
                appendTo="body"
                (completeMethod)="filtrarProveedores($event)"
                (onSelect)="seleccionarProveedorFila(c, $event.value ?? $event)"
                (onClear)="limpiarProveedorFila(c)"
                (onDropdownClick)="filtrarProveedores({ query: '' })"
                (click)="$event.stopPropagation()"
              ></p-autoComplete>
            </td>
          <td class="px-3 py-2">
            <input
              [(ngModel)]="c.descripcion"
              [disabled]="!c.enEdicion"
              class="w-full"
              pInputText
              type="text"
              (click)="$event.stopPropagation()"
            />
          </td>
          <td class="px-3 py-2">
            <div class="flex gap-2 items-center">
              <div class="flex flex-col gap-1 w-20">
                <input
                  [(ngModel)]="c.cantidad"
                  (input)="recalcularEnEdicion(c)"
                  [disabled]="!c.enEdicion"
                  class="w-full"
                  min="0"
                  pInputText
                  type="number"
                  (click)="$event.stopPropagation()"
                />
              </div>
              <div class="flex flex-col gap-1 w-16">
                <input
                  [(ngModel)]="c.unidad"
                  [disabled]="!c.enEdicion"
                  class="w-full"
                  pInputText
                  placeholder="Unidad"
                  type="text"
                  (click)="$event.stopPropagation()"
                />
              </div>
            </div>
          </td>
          <td class="px-3 py-2">
            <div class="flex justify-start">
              <p-inputNumber
                [(ngModel)]="c.precio_unitario"
                (onInput)="recalcularEnEdicion(c)"
                [disabled]="!c.enEdicion"
                mode="decimal"
                locale="es-AR"
                [useGrouping]="true"
                [minFractionDigits]="2"
                [maxFractionDigits]="2"
                inputStyleClass="w-full text-left"
                [min]="0"
                (onClick)="$event.stopPropagation()">
              </p-inputNumber>
            </div>
          </td>

          <td class="px-3 py-2 text-right">
            @if (c.tipo_costo === 'ADICIONAL') {
              @if (c.enEdicion) {
                <div class="flex items-center justify-end gap-2 text-xs text-gray-700">
                  <span>Individual (</span>
                  <input
                    [(ngModel)]="c.beneficio"
                    (input)="recalcularEnEdicion(c)"
                    class="w-16 text-right"
                    pInputText
                    type="number"
                    (click)="$event.stopPropagation()"
                  />
                  <span>%)</span>
                </div>
              } @else {
                <span class="text-gray-500 text-xs">
                  Individual ({{ c.beneficio ?? 0 }}%)
                </span>
              }
            } @else if (usarBeneficioGlobal) {
              <span class="text-gray-500 text-xs">
                Global ({{ beneficioGlobal }}%)
              </span>
            } @else {
              <input
                [(ngModel)]="c.beneficio"
                (input)="recalcularEnEdicion(c)"
                [disabled]="!c.enEdicion"
                class="w-16 text-right"
                pInputText
                type="number"
                (click)="$event.stopPropagation()"
              />
            }
          </td>

          <td class="px-3 py-2">
            <div class="flex justify-start">
              <span class="font-medium">{{ c.subtotal | currency:'ARS' }}</span>
            </div>
          </td>

          <td class="px-3 py-2 font-semibold">
            <div class="flex justify-start">
              <span>{{ c.total | currency:'ARS' }}</span>
            </div>
          </td>

        </tr>
      </ng-template>

      <!-- Footer -->
      <ng-template pTemplate="footer">
        <tr class="bg-gray-100 font-semibold">
          <td class="text-right px-3 py-2" colspan="7">Presupuestado:</td>
          <td class="px-3 py-2">
            <div class="flex justify-start">{{ calcularTotalConBeneficio() | currency:'ARS' }}</div>
          </td>
        </tr>

        <tr class="bg-gray-50 text-sm">
          <td class="text-right px-3 py-2 text-gray-600" colspan="7">Costos (Material y mano de obra):</td>
          <td class="px-3 py-2 text-gray-700 font-medium">
            <div class="flex justify-start">{{ calcularSubtotal() | currency:'ARS' }}</div>
          </td>
        </tr>

        <tr class="bg-gray-50 text-sm">
          <td class="text-right px-3 py-2 text-gray-600" colspan="7">
            Comisiones
            @if (tieneComision) {
              <span> ({{ comision }}%)</span>
            }
          </td>
          <td class="px-3 py-2 text-indigo-600 font-medium">
            <div class="flex justify-start">{{ calcularComisionMonto() | currency:'ARS' }}</div>
          </td>
        </tr>

        <tr class="bg-gray-200 font-bold">
          <td class="text-right px-3 py-2" colspan="7">Beneficio neto:</td>
          <td class="px-3 py-2 text-green-700">
            <div class="flex justify-start">{{ calcularBeneficioNeto() | currency:'ARS' }}</div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  } @else {
    <div class="text-center text-gray-500 py-10">
      No hay costos cargados para esta obra.
    </div>
  }

  <app-modal
    [visible]="showCostoDetalleModal"
    [title]="'Detalle de costo'"
    [width]="'900px'"
    [showFooter]="false"
    (closed)="cerrarDetalleCosto()"
  >
    <div class="p-3 space-y-4">
      @if (costoDetalle && costoDetalleDraft) {
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="flex flex-col gap-2">
              <label class="text-sm font-medium text-gray-700">Item</label>
              <input
                class="p-inputtext p-component w-full max-w-[220px] text-sm py-1"
                [(ngModel)]="costoDetalleDraft.item_numero"
                [disabled]="!costoDetalleEditando"
                type="text"/>
            </div>
            <div class="flex flex-col gap-2">
              <label class="text-sm font-medium text-gray-700">Proveedor</label>
              @if (costoDetalleEditando) {
                <p-autoComplete
                  [(ngModel)]="costoDetalleDraft.proveedor"
                  [suggestions]="filteredProveedores"
                  (completeMethod)="filtrarProveedores($event)"
                  field="nombre"
                  [dropdown]="true"
                  placeholder="Buscar proveedor"
                  styleClass="w-full max-w-[260px]"
                  inputStyleClass="text-sm py-1"
                  (onSelect)="seleccionarProveedorFila(costoDetalleDraft, $event.value ?? $event)">
                </p-autoComplete>
            } @else {
              <input
                class="p-inputtext p-component w-full max-w-[260px] text-sm py-1"
                [value]="costoDetalle.proveedor?.nombre || 'Sin proveedor'"
                disabled
                type="text"/>
            }
            </div>
            <div class="flex flex-col gap-2">
              <label class="text-sm font-medium text-gray-700">Cantidad</label>
              <input
                class="p-inputtext p-component w-full max-w-[220px] text-sm py-1"
                [(ngModel)]="costoDetalleDraft.cantidad"
                [disabled]="!costoDetalleEditando"
                (input)="recalcularEnEdicion(costoDetalleDraft)"
                type="text"/>
            </div>
            <div class="flex flex-col gap-2">
              <label class="text-sm font-medium text-gray-700">Unidad</label>
              <input
                class="p-inputtext p-component w-full max-w-[220px] text-sm py-1"
                [(ngModel)]="costoDetalleDraft.unidad"
                [disabled]="!costoDetalleEditando"
                type="text"/>
            </div>
            <div class="flex flex-col gap-2">
              <label class="text-sm font-medium text-gray-700">Precio unitario</label>
              @if (costoDetalleEditando) {
                <p-inputNumber
                  [(ngModel)]="costoDetalleDraft.precio_unitario"
                  (onInput)="recalcularEnEdicion(costoDetalleDraft)"
                  mode="decimal"
                  locale="es-AR"
                  [useGrouping]="true"
                  [minFractionDigits]="2"
                  [maxFractionDigits]="2"
                  inputStyleClass="w-full max-w-[220px] text-left text-sm py-1"
                  [min]="0">
                </p-inputNumber>
            } @else {
              <input
                class="p-inputtext p-component w-full max-w-[220px] text-sm py-1"
                [value]="(costoDetalle.precio_unitario | currency:'ARS':'symbol':'1.0-2') || ''"
                disabled
                type="text"/>
            }
            </div>
            <div class="flex flex-col gap-2">
              <label class="text-sm font-medium text-gray-700">Beneficio (%)</label>
              <input
                class="p-inputtext p-component w-full max-w-[220px] text-sm py-1"
                [(ngModel)]="costoDetalleDraft.beneficio"
                [disabled]="!costoDetalleEditando"
                (input)="recalcularEnEdicion(costoDetalleDraft)"
                type="text"/>
            </div>
            <div class="flex flex-col gap-2">
              <label class="text-sm font-medium text-gray-700">Subtotal</label>
              <input
                class="p-inputtext p-component w-full max-w-[220px] text-sm py-1"
                [value]="(costoDetalleDraft.subtotal | currency:'ARS':'symbol':'1.0-2') || ''"
                disabled
                type="text"/>
            </div>
            <div class="flex flex-col gap-2">
              <label class="text-sm font-medium text-gray-700">Total</label>
              <input
                class="p-inputtext p-component w-full max-w-[220px] text-sm py-1"
                [value]="(costoDetalleDraft.total | currency:'ARS':'symbol':'1.0-2') || ''"
                disabled
                type="text"/>
            </div>
          </div>
          <div class="md:col-span-2 flex flex-col gap-2">
            <label class="text-sm font-medium text-gray-700">Descripcion</label>
            <p-editor
              [(ngModel)]="costoDetalleDraft.descripcion"
              [readonly]="!costoDetalleEditando"
              [style]="{ height: '235px' }">
            </p-editor>
          </div>
        </div>

        <div class="flex justify-end gap-2">
          @if (costoDetalleEditando) {
            <p-button label="Cancelar" icon="pi pi-times" (onClick)="cancelarEdicionDetalleCosto()"></p-button>
            <p-button label="Guardar" icon="pi pi-check" (onClick)="guardarDetalleCosto()"></p-button>
          } @else {
            <p-button label="Cerrar" icon="pi pi-times" (onClick)="cerrarDetalleCosto()"></p-button>
            <p-button
              label="Editar"
              icon="pi pi-pencil"
              [disabled]="!puedeEditarCosto(costoDetalle)"
              (onClick)="editarDetalleCosto()">
            </p-button>
            <p-button
              label="Eliminar"
              icon="pi pi-trash"
              severity="danger"
              [disabled]="!puedeEditarCosto(costoDetalle)"
              (onClick)="eliminarDetalleCosto()">
            </p-button>
          }
        </div>
      }
    </div>
  </app-modal>

</div>

