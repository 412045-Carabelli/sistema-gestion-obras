<p-toast position="bottom-right"></p-toast>

<div class="p-4 space-y-5">
  <!-- Header -->
  <div class="flex justify-between items-center flex-wrap gap-3">
    <div>
      <h2 class="text-2xl font-bold text-gray-900">Presupuesto</h2>
      <p class="text-gray-500 text-sm mt-1">
        Matriz de costos detallada de la obra
      </p>
    </div>

    <div class="flex gap-5 items-center">
      <p class="text-sm text-gray-700">
        <strong>Beneficio:</strong>
        {{ usarBeneficioGlobal ? 'Global (' + beneficioGlobal + '%)' : 'Individual' }}
      </p>

      <p-button
        (onClick)="exportarPDF()"
        icon="pi pi-file-pdf"
        label="Exportar PDF"
        styleClass="p-button-md p-button-primary"
      ></p-button>
    </div>
  </div>

  <!-- Formulario rápido para agregar costos -->
  <div class="grid grid-cols-1 lg:grid-cols-5 gap-3 bg-gray-50 border border-dashed border-gray-200 p-3 rounded-lg">
      <div class="flex flex-col gap-1">
        <label class="text-xs text-gray-600">Proveedor</label>
        <p-select
          [(ngModel)]="nuevoCosto.id_proveedor"
          [options]="proveedores"
          optionLabel="nombre"
          optionValue="id"
          placeholder="Proveedor"
          styleClass="w-full"
        ></p-select>
      </div>
    <div class="flex flex-col gap-1 lg:col-span-2">
      <label class="text-xs text-gray-600">Descripción</label>
      <input
        [(ngModel)]="nuevoCosto.descripcion"
        class="w-full"
        pInputText
        placeholder="Descripción"
        type="text"
      />
    </div>
    <div class="flex gap-2">
      <div class="flex flex-col gap-1 w-1/3">
        <label class="text-xs text-gray-600">Cantidad</label>
        <input
          [(ngModel)]="nuevoCosto.cantidad"
          class="w-full"
          min="0"
          pInputText
          placeholder="Cant."
          type="number"
        />
      </div>
      <div class="flex flex-col gap-1 w-1/3">
        <label class="text-xs text-gray-600">Precio unitario</label>
        <input
          [(ngModel)]="nuevoCosto.precio_unitario"
          class="w-full"
          min="0"
          pInputText
          placeholder="Precio"
          type="number"
        />
      </div>
      <div class="flex flex-col gap-1 w-1/3">
        <label class="text-xs text-gray-600">Unidad</label>
        <input
          [(ngModel)]="nuevoCosto.unidad"
          class="w-full"
          pInputText
          placeholder="Ej: m2"
          type="text"
        />
      </div>
    </div>
    <div class="flex gap-2 items-end">
      <div class="flex flex-col gap-1">
        <label class="text-xs text-gray-600">Beneficio (%)</label>
        <input
          [(ngModel)]="nuevoCosto.beneficio"
          [disabled]="usarBeneficioGlobal"
          class="w-20"
          min="0"
          pInputText
          placeholder="%"
          type="number"
        />
      </div>
      <p-button icon="pi pi-plus" label="Agregar" (onClick)="agregarCosto()"></p-button>
    </div>
  </div>

  <!-- Tabla de costos -->
  @if (costosFiltrados.length > 0) {
    <p-table
      [value]="costosFiltrados"
      class="text-sm p-datatable-sm border border-gray-200 rounded-lg overflow-hidden"
      responsiveLayout="scroll"
    >
      <!-- Encabezado -->
      <ng-template pTemplate="header">
        <tr class="bg-gray-50 text-gray-700">
          <th class="text-left px-3 py-2 font-semibold">Proveedor</th>
          <th class="text-left px-3 py-2 font-semibold">Descripción</th>
          <th class="text-left px-3 py-2 font-semibold">Cantidad</th>
          <th class="text-left px-3 py-2 font-semibold">Precio Unit.</th>
          <th class="text-left px-3 py-2 font-semibold">Beneficio (%)</th>
          <th class="text-left px-3 py-2 font-semibold">Estado de pago</th>
          <th class="text-left px-3 py-2 font-semibold">Total</th>
          <th class="text-left px-3 py-2 font-semibold">Acciones</th>
        </tr>
      </ng-template>

      <!-- Filas -->
      <ng-template let-c let-rowIndex="rowIndex" pTemplate="body">
        <tr
          [ngClass]="rowIndex % 2 === 0 ? 'bg-white' : 'bg-gray-50'"
          class="hover:bg-gray-50 transition"
        >
            <td class="px-3 py-2">
              <p-select
                [(ngModel)]="c.id_proveedor"
                [disabled]="!c.enEdicion"
                [options]="proveedores"
                optionLabel="nombre"
                optionValue="id"
                placeholder="Proveedor"
                styleClass="w-full"
              ></p-select>
            </td>
          <td class="px-3 py-2">
            <input
              [(ngModel)]="c.descripcion"
              [disabled]="!c.enEdicion"
              class="w-full"
              pInputText
              type="text"
            />
          </td>
          <td class="px-3 py-2">
            <div class="flex gap-2 items-center">
              <div class="flex flex-col gap-1 w-20">
                <input
                  [(ngModel)]="c.cantidad"
                  (input)="recalcularEnEdicion(c)"
                  [disabled]="!c.enEdicion"
                  class="w-full"
                  min="0"
                  pInputText
                  type="number"
                />
              </div>
              <div class="flex flex-col gap-1 w-16">
                <input
                  [(ngModel)]="c.unidad"
                  [disabled]="!c.enEdicion"
                  class="w-full"
                  pInputText
                  placeholder="Unidad"
                  type="text"
                />
              </div>
            </div>
          </td>
          <td class="px-3 py-2 text-right">
            <input
              [(ngModel)]="c.precio_unitario"
              (input)="recalcularEnEdicion(c)"
              [disabled]="!c.enEdicion"
              class="w-full text-right"
              min="0"
              pInputText
              type="number"
            />
          </td>

          <td class="px-3 py-2 text-right">
            @if (usarBeneficioGlobal) {
              <span class="text-gray-500 text-xs">
                Global ({{ beneficioGlobal }}%)
              </span>
            } @else {
              <input
                [(ngModel)]="c.beneficio"
                (input)="recalcularEnEdicion(c)"
                [disabled]="!c.enEdicion"
                class="w-16 text-right"
                pInputText
                type="number"
              />
            }
          </td>

          <td class="px-3 py-2">
            <p-select
              (ngModelChange)="actualizarEstadoPago(c, $event)"
              [(ngModel)]="c.estado_pago"
              [disabled]="c.enEdicion"
              [options]="estadosPagoRecords"
              optionLabel="label"
              optionValue="name"
              styleClass="w-40"
            ></p-select>
          </td>

          <td class="px-3 py-2 text-right font-semibold">
            {{ c.total | currency }}
          </td>

          <td class="px-3 py-2">
            <div class="flex gap-1 justify-end">
              @if (!c.enEdicion) {
                <p-button icon="pi pi-pencil" styleClass="p-button-text p-button-sm" (onClick)="habilitarEdicion(c)"></p-button>
              }
              @if (c.enEdicion) {
                <p-button icon="pi pi-check" styleClass="p-button-success p-button-sm" (onClick)="guardarEdicion(c)"></p-button>
                <p-button icon="pi pi-times" styleClass="p-button-secondary p-button-sm" (onClick)="c.enEdicion=false"></p-button>
              }
              <p-button icon="pi pi-trash" styleClass="p-button-danger p-button-text p-button-sm" (onClick)="eliminarCosto(c)"></p-button>
            </div>
          </td>
        </tr>
      </ng-template>

      <!-- Footer -->
      <ng-template pTemplate="footer">
        <tr class="bg-gray-100 font-semibold">
          <td class="text-right px-3 py-2" colspan="6">Subtotal:</td>
          <td class="px-3 py-2">{{ calcularTotal() | currency:'ARS' }}</td>
        </tr>

        @if (usarBeneficioGlobal) {
          <tr class="bg-gray-50 text-sm">
            <td class="text-right px-3 py-2 text-gray-600" colspan="6">
              Beneficio Global ({{ beneficioGlobal }}%):
            </td>
            <td class="px-3 py-2 text-blue-600 font-medium">
              {{ (calcularTotal() * (beneficioGlobal / 100)) | currency:'ARS' }}
            </td>
          </tr>
        }

        <tr class="bg-gray-50 text-sm">
          <td class="text-right px-3 py-2 text-gray-600" colspan="6">
            Comisión ({{ comision }}%):
          </td>
          <td class="px-3 py-2 text-indigo-600 font-medium">
            {{ (tieneComision ? (calcularTotal() * comision / 100) : 0) | currency:'ARS' }}
          </td>
        </tr>

        <tr class="bg-gray-200 font-bold">
          <td class="text-right px-3 py-2" colspan="6">Presupuesto Total:</td>
          <td class="px-3 py-2 text-green-700">
            {{ getPresupuestoTotal() | currency:'ARS' }}
          </td>
        </tr>

        <tr class="bg-gray-50 text-sm">
          <td class="text-right px-3 py-2 text-gray-600" colspan="6">Pagado:</td>
          <td class="px-3 py-2 text-green-600 font-medium">
            {{ calcularTotalPorEstado('PAGADO') | currency:'ARS' }}
          </td>
        </tr>

        <tr class="bg-gray-50 text-sm">
          <td class="text-right px-3 py-2 text-gray-600" colspan="6">Pendiente:</td>
          <td class="px-3 py-2 text-amber-600 font-medium">
            {{ calcularTotalPorEstado('PENDIENTE') | currency:'ARS' }}
          </td>
        </tr>
      </ng-template>
    </p-table>
  } @else {
    <div class="text-center text-gray-500 py-10">
      No hay costos cargados para esta obra.
    </div>
  }
</div>

<!-- Modal para registrar pago -->
<app-modal
  [visible]="modalPagoVisible"
  [title]="'Registrar movimiento de pago'"
  (closed)="cancelarPago()"
  (confirmed)="confirmarPago()">
  <div class="flex flex-col gap-3 py-2">
    <div class="flex flex-col gap-1">
      <label class="text-sm font-medium text-gray-700">Tipo de movimiento</label>
      <p-select
        [(ngModel)]="transaccionForm.tipo_movimiento"
        [options]="[{label:'Pago', value:'PAGO'},{label:'Cobro', value:'COBRO'}]"
        optionLabel="label"
        optionValue="value"
        styleClass="w-full">
      </p-select>
    </div>
    <div class="flex flex-col gap-1">
      <label class="text-sm font-medium text-gray-700">Monto</label>
      <input pInputText type="number" [(ngModel)]="transaccionForm.monto" class="w-full" />
    </div>
    <div class="flex flex-col gap-1">
      <label class="text-sm font-medium text-gray-700">Forma de pago</label>
      <p-select
        [(ngModel)]="transaccionForm.forma_pago"
        [options]="[{label:'Total', value:'TOTAL'},{label:'Parcial', value:'PARCIAL'}]"
        optionLabel="label"
        optionValue="value"
        styleClass="w-full">
      </p-select>
    </div>
    <div class="flex flex-col gap-1">
      <label class="text-sm font-medium text-gray-700">Fecha</label>
      <input pInputText type="date" [(ngModel)]="transaccionForm.fecha" class="w-full" />
    </div>
    <div class="flex flex-col gap-1">
      <label class="text-sm font-medium text-gray-700">Observación</label>
      <textarea class="w-full border rounded p-2 text-sm" [(ngModel)]="transaccionForm.observacion" rows="3"></textarea>
    </div>
    @if (errorApi) {
      <div class="text-sm text-red-600 bg-red-50 border border-red-200 rounded p-2">
        {{ errorApi }}
      </div>
    }
  </div>
</app-modal>
