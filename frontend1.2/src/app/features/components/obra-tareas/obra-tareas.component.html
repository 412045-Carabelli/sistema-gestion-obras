<p-toast></p-toast>
<div class="flex flex-col gap-3">
  <!-- Header -->
  <div class="flex w-full justify-between items-center">
    <div class="p-5">
      <h1 class="text-2xl font-semibold text-black">Gestión de tareas</h1>
      <p class="text-gray-600">Progreso por proveedor <span class="font-semibold text-gray-800" *ngIf="obraNombre">· {{ obraNombre }}</span></p>
    </div>
    <p-button (onClick)="abrirModal()" icon="pi pi-plus" label="Nueva Tarea"></p-button>
  </div>

  <!-- Lista por proveedor -->
  @for (proveedor of proveedores; track proveedor.id) {
    <div class="rounded-lg p-5 bg-gray-50">
      <div class="flex justify-between items-center mb-2">
        <div>
          <h3 class="font-semibold text-xl text-gray-800">{{ proveedor.nombre }}</h3>
          <p class="text-sm text-gray-700">
            {{ getCompletadas(proveedor.id) }} / {{ getTotales(proveedor.id) }} completadas
          </p>
        </div>
      </div>

      <p-progressBar [value]="progreso(proveedor.id)"></p-progressBar>

      <div class="space-y-2 mt-3">
        @for (tarea of tareasProveedor(proveedor.id); track tarea.id) {
          <div
            class="flex justify-between items-center border rounded-md p-2 cursor-pointer"
            [ngClass]="claseEstado(tarea)"
            (click)="toggleTarea(tarea)"
          >
            <div class="flex items-center gap-2">
              <i
                class="pi text-lg"
                [ngClass]="{
                  'pi-check-circle text-green-600': tarea.estado_tarea === 'COMPLETADA',
                  'pi-circle text-gray-400': tarea.estado_tarea !== 'COMPLETADA'
                }"
              ></i>
              <span [class.line-through]="tarea.estado_tarea === 'COMPLETADA'">
                {{ tarea.nombre }}
              </span>
            </div>
            <div class="flex items-center gap-2">
              <p-button
                icon="pi pi-pencil"
                styleClass="p-button-text p-button-sm"
                (onClick)="editarTarea(tarea); $event.stopPropagation()"
              ></p-button>
              <p-button
                icon="pi pi-trash"
                styleClass="p-button-text p-button-sm text-red-500"
                (onClick)="eliminarTarea(tarea.id!); $event.stopPropagation()"
              ></p-button>
            </div>
          </div>
        }
      </div>
    </div>
  }

  <!-- Modal -->
  <app-modal
    (closed)="cerrarModal()"
    (confirmed)="guardarTarea()"
    [visible]="showAddTaskModal"
    [title]="editandoTarea ? 'Editar Tarea' : 'Nueva Tarea'"
  >
    <div class="p-3 space-y-3">
      <label class="block text-sm font-medium">Nombre de la tarea</label>
      <input
        [(ngModel)]="nuevaTarea.nombre"
        class="w-full"
        pInputText
        type="text"
      />

      <label class="block text-sm font-medium">Descripción</label>
      <textarea
        [(ngModel)]="nuevaTarea.descripcion"
        class="w-full p-2 border rounded-md"
        rows="3"
        placeholder="Detalle o notas de la tarea"></textarea>

      <label class="block text-sm font-medium">Proveedor</label>
      <p-select
        [(ngModel)]="nuevaTarea.proveedor"
        [options]="proveedores"
        appendTo="body"
        class="w-full"
        optionLabel="nombre"
        placeholder="Seleccionar proveedor">
      </p-select>

      <label class="block text-sm font-medium">Estado</label>
      <p-select
        [(ngModel)]="nuevaTarea.estado_tarea"
        [options]="['PENDIENTE', 'EN PROGRESO', 'COMPLETADA']"
        appendTo="body"
        class="w-full"
        placeholder="Seleccionar estado">
      </p-select>
    </div>
  </app-modal>
</div>
