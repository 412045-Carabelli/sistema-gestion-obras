@if (!datosCargados) {
  <div class="flex justify-center items-center min-h-[60vh]">
    <p-progressSpinner styleClass="w-16 h-16" strokeWidth="4" animationDuration=".8s"></p-progressSpinner>
  </div>
} @else {
  <div class="space-y-6">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div
        class="bg-white rounded-xl shadow-md p-5 border-l-4 border-emerald-500"
        pTooltip="Total facturado de las obras segun el filtro actual."
        tooltipPosition="top">
        <p class="text-xs text-emerald-700 font-semibold uppercase">Facturado</p>
        <p class="text-2xl font-bold text-gray-900">{{ totalFacturado | currency:'ARS':'symbol':'1.0-2' }}</p>
      </div>
      <div
        class="bg-white rounded-xl shadow-md p-5 border-l-4 border-blue-500"
        pTooltip="Sumatoria de movimientos de COBRO segun el filtro actual."
        tooltipPosition="top">
        <p class="text-xs text-blue-700 font-semibold uppercase">Cobrado</p>
        <p class="text-2xl font-bold text-gray-900">{{ totalCobrado | currency:'ARS':'symbol':'1.0-2' }}</p>
      </div>
      <div
        class="bg-white rounded-xl shadow-md p-5 border-l-4 border-amber-500"
        pTooltip="Presupuesto menos cobrado, segun el filtro actual."
        tooltipPosition="top">
        <p class="text-xs text-amber-700 font-semibold uppercase">Por cobrar</p>
        <p class="text-2xl font-bold text-gray-900">{{ totalPorCobrar | currency:'ARS':'symbol':'1.0-2' }}</p>
      </div>
      <div
        class="bg-white rounded-xl shadow-md p-5 border-l-4 border-indigo-500"
        pTooltip="Cobrado menos presupuesto, segun el filtro actual."
        tooltipPosition="top">
        <p class="text-xs text-indigo-700 font-semibold uppercase">Saldo</p>
        <p class="text-2xl font-bold text-gray-900">{{ saldoFinal | currency:'ARS':'symbol':'1.0-2' }}</p>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow-md p-4">
      <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
        <div class="flex flex-col gap-2 md:col-span-6">
          <label class="text-sm font-medium text-gray-700">Buscar</label>
          <input
            pInputText
            type="text"
            [(ngModel)]="searchValue"
            (input)="applyFilter()"
            placeholder="Cliente, obra o # factura"
          />
        </div>
        <div class="flex flex-col gap-2 md:col-span-3">
          <label class="text-sm font-medium text-gray-700">Cliente</label>
          <p-select
            [options]="clientesOptions"
            [(ngModel)]="clienteFiltro"
            (ngModelChange)="onClienteChange()"
            placeholder="Todos los clientes"
            optionLabel="label"
            optionValue="value"
            appendTo="body">
          </p-select>
        </div>
        <div class="flex flex-col gap-2 md:col-span-3">
          <label class="text-sm font-medium text-gray-700">Obra</label>
          <p-select
            [options]="obrasOptions"
            [(ngModel)]="obraFiltro"
            (ngModelChange)="applyFilter()"
            placeholder="Todas las obras"
            optionLabel="label"
            optionValue="value"
            appendTo="body">
          </p-select>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow-md overflow-hidden">
      <p-table
        [value]="facturasFiltradas"
        [paginator]="true"
        [rows]="8"
        responsiveLayout="scroll"
        styleClass="p-datatable-sm">
        <ng-template pTemplate="header">
          <tr>
            <th class="bg-gray-50 px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Cliente</th>
            <th class="bg-gray-50 px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Obra</th>
            <th class="bg-gray-50 px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Fecha</th>
            <th class="bg-gray-50 px-4 py-3 text-right text-xs font-semibold text-gray-500 uppercase">Monto</th>
            <th class="bg-gray-50 px-4 py-3 text-right text-xs font-semibold text-gray-500 uppercase">Por cobrar</th>
            <th class="bg-gray-50 px-4 py-3 text-right text-xs font-semibold text-gray-500 uppercase">Acciones</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-f>
          <tr class="hover:bg-gray-50 transition-colors cursor-pointer" (click)="onRowClick(f)">
            <td class="px-4 py-3 text-sm text-gray-700">{{ f.clienteNombre }}</td>
            <td class="px-4 py-3 text-sm text-gray-700">{{ f.obraNombre }}</td>
            <td class="px-4 py-3 text-sm text-gray-700">{{ f.fecha | date:'dd/MM/yyyy' }}</td>
            <td class="px-4 py-3 text-sm text-gray-900 text-right">
              {{ f.monto | currency:'ARS':'symbol':'1.0-2' }}
            </td>
            <td class="px-4 py-3 text-sm text-gray-900 text-right">
              {{ f.porCobrarObra | currency:'ARS':'symbol':'1.0-2' }}
            </td>
            <td class="px-4 py-3 text-right">
              <p-button
                icon="pi pi-download"
                styleClass="p-button-text p-button-sm"
                (onClick)="downloadFactura($event, f)"
                pTooltip="Descargar factura"
                tooltipPosition="left">
              </p-button>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="7" class="text-center py-10 text-gray-500">
              <i class="pi pi-inbox text-4xl mb-2"></i>
              <p>No hay facturas registradas</p>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>
}
