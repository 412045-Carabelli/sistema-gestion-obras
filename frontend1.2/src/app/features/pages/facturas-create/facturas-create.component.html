<p-toast position="bottom-right"></p-toast>

<div class="p-6 w-full bg-white rounded-xl shadow-sm">
  <form class="space-y-6" [formGroup]="form" (ngSubmit)="onSubmit()">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="flex flex-col gap-4">
        <div class="flex flex-col md:flex-row gap-4">
          <div class="flex flex-col flex-1">
            <label class="text-sm font-medium text-gray-700 mb-1">Cliente</label>
            <p-select
              formControlName="id_cliente"
              [options]="clientes"
              optionLabel="nombre"
              optionValue="id"
              placeholder="Selecciona un cliente"
              appendTo="body"
              class="w-full">
            </p-select>
            @if (form.get('id_cliente')?.touched && form.get('id_cliente')?.hasError('required')) {
              <small class="text-red-500 text-xs mt-1">Selecciona un cliente</small>
            }
          </div>

          <div class="flex flex-col flex-1">
            <label class="text-sm font-medium text-gray-700 mb-1">Obra</label>
            <p-select
              formControlName="id_obra"
              [options]="obrasFiltradas"
              optionLabel="nombre"
              optionValue="id"
              placeholder="Selecciona una obra"
              appendTo="body"
              class="w-full">
            </p-select>
            @if (restanteObra != null) {
              <small class="text-gray-500 text-xs mt-1">
                Restante por facturar: {{ restanteObra | currency:'ARS':'symbol':'1.0-2' }}
              </small>
            }
          </div>
        </div>

        <div class="flex flex-col md:flex-row gap-4 items-start">
          <div class="flex flex-col w-full md:w-1/2">
            <label class="text-sm font-medium text-gray-700 mb-1">Estado</label>
            <p-select
              formControlName="estado"
              [options]="estadoOptions"
              optionLabel="label"
              optionValue="value"
              placeholder="Selecciona un estado"
              appendTo="body"
              class="w-full">
            </p-select>
          </div>

          <div class="flex items-center gap-3 pt-6 self-center">
            <p-checkbox
              formControlName="impacta_cta_cte"
              [binary]="true"
              inputId="impactaCtaCte">
            </p-checkbox>
            <label for="impactaCtaCte" class="text-sm font-medium text-gray-700">
              Impacta en cta. cte.
            </label>
          </div>
        </div>
      </div>

      <div class="flex flex-col gap-4">
        <div class="flex flex-col md:flex-row gap-4">
          <div class="flex flex-col flex-1">
            <label class="text-sm font-medium text-gray-700 mb-1">Fecha</label>
            <p-datepicker
              formControlName="fecha"
              dateFormat="dd/mm/yy"
              showIcon="true"
              appendTo="body"
              fluid
              class="w-full">
            </p-datepicker>
            @if (form.get('fecha')?.touched && form.get('fecha')?.hasError('required')) {
              <small class="text-red-500 text-xs mt-1">Selecciona una fecha</small>
            }
          </div>

          <div class="flex flex-col flex-1">
            <label class="text-sm font-medium text-gray-700 mb-1">Monto</label>
            <p-inputNumber
              formControlName="monto"
              mode="decimal"
              locale="es-AR"
              [useGrouping]="true"
              [minFractionDigits]="2"
              [maxFractionDigits]="2"
              inputStyleClass="w-full"
              placeholder="0">
            </p-inputNumber>
            @if (form.get('monto')?.touched && form.get('monto')?.hasError('required')) {
              <small class="text-red-500 text-xs mt-1">Ingresa un monto</small>
            }
          </div>
        </div>

        <div class="flex flex-col gap-2 items-start">
          <label class="text-sm font-medium text-gray-700">Adjuntar factura (opcional)</label>
          <p-fileUpload
            mode="basic"
            chooseLabel="Seleccionar archivo"
            chooseIcon="pi pi-upload"
            accept=".jpg,.jpeg,.png,.pdf"
            [auto]="false"
            (onSelect)="onFileSelected($event)">
          </p-fileUpload>
          @if (selectedFile) {
            <div class="flex items-center gap-2 text-sm text-gray-700">
              <span>{{ selectedFile.name }}</span>
              <button type="button" class="text-red-500 hover:text-red-700" (click)="quitarArchivo()">Ä®-</button>
            </div>
          }
        </div>
      </div>
    </div>

    <div class="flex flex-col gap-2">
      <label class="text-sm font-medium text-gray-700">Descripcion</label>
      <p-editor
        formControlName="descripcion"
        [style]="{ height: '180px' }">
      </p-editor>
    </div>

    <div class="flex justify-end gap-3">
      <p-button label="Volver" icon="pi pi-arrow-left" styleClass="p-button-text" routerLink="/facturas"></p-button>
      <p-button type="submit" label="Guardar factura" icon="pi pi-save" styleClass="p-button-primary"></p-button>
    </div>
  </form>
</div>
