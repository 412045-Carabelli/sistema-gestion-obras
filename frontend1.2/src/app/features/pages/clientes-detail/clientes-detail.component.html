<p-toast></p-toast>

@if (loading) {
  <div class="flex justify-center items-center min-h-[60vh]">
    <p-progressSpinner pStyleClass="w-16 h-16" strokeWidth="4" animationDuration=".8s"></p-progressSpinner>
  </div>
} @else {
  @defer (when cliente) {
    <div class="p-4 space-y-8 w-full mx-auto">

      <!-- ===================== TARJETAS DE INFO PRINCIPAL ===================== -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">

        <!-- Tarjeta Contacto -->
        <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-blue-500 hover:shadow-lg transition-shadow">
          <div class="flex items-center gap-3 mb-2">
            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
              <i class="pi pi-user text-blue-600 text-lg"></i>
            </div>
            <span class="text-sm font-medium text-gray-500">Contacto</span>
          </div>
          <p class="text-lg font-semibold text-gray-900">{{ cliente.contacto || 'Sin contacto' }}</p>
        </div>

        <!-- Tarjeta CUIT -->
        <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-cyan-500 hover:shadow-lg transition-shadow">
          <div class="flex items-center gap-3 mb-2">
            <div class="w-10 h-10 bg-cyan-100 rounded-lg flex items-center justify-center">
              <i class="pi pi-id-card text-cyan-600 text-lg"></i>
            </div>
            <span class="text-sm font-medium text-gray-500">CUIT</span>
          </div>
          <p class="text-lg font-semibold text-gray-900">{{ cliente.cuit || 'Sin CUIT' }}</p>
        </div>

        <!-- Obras activas -->
        <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-green-500 hover:shadow-lg transition-shadow">
          <div class="flex items-center gap-3 mb-2">
            <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
              <i class="pi pi-building text-green-600 text-lg"></i>
            </div>
            <span class="text-sm font-medium text-gray-500">Obras en progreso</span>
          </div>
          <p class="text-lg font-semibold text-gray-900">{{ obrasActivas }}</p>
        </div>

        <!-- Saldo Pendiente -->
        <div class="bg-gradient-to-br from-orange-500 to-orange-700 rounded-xl shadow-md p-6 text-white">
          <h3 class="text-lg font-semibold flex items-center gap-2 mb-2">
            <i class="pi pi-money-bill"></i>
            Saldo pendiente
          </h3>
          <div class="text-center flex">
            <p class="text-2xl font-bold">{{ saldoPendiente | currency:'ARS':'symbol':'1.0-0' }}</p>
          </div>
          <p class="text-xs text-orange-100 mt-1">Por cobrar</p>
        </div>
      </div>

      </div>

      <div class="flex justify-end px-2">
        <p-button
          icon="pi pi-file-pdf"
          label="Descargar PDF"
          styleClass="p-button-sm"
          (onClick)="exportarDetallePdf()"
        ></p-button>
      </div>

      <!-- ===================== TABS MEJORADOS ===================== -->
      <div class="mx-4 bg-white rounded-xl shadow-md overflow-hidden">
        <p-tabs value="0">
          <p-tablist pStyleClass="border-b border-gray-200 px-6">
            <p-tab value="0" pStyleClass="px-6 py-4">
              <div class="flex items-center gap-2">
                <i class="pi pi-building"></i>
                <span class="font-medium">Obras</span>
                <span class="ml-2 px-2 py-1 bg-cyan-100 text-cyan-700 text-xs font-semibold rounded-full">
                  {{ obras.length || 0 }}
                </span>
              </div>
            </p-tab>
            <p-tab value="1" pStyleClass="px-6 py-4">
              <div class="flex items-center gap-2">
                <i class="pi pi-file"></i>
                <span class="font-medium">Documentos</span>
              </div>
            </p-tab>
          </p-tablist>

          <p-tabpanels pStyleClass="p-6">
            <!-- TAB: OBRAS -->
            <p-tabpanel value="0">
              @if (obras && obras.length > 0) {
                <div class="overflow-hidden rounded-lg border border-gray-200">
                  <p-table
                    [value]="obras"
                    [tableStyle]="{ 'min-width': '100%' }"
                    pStyleClass="w-full"
                  >
                    <ng-template pTemplate="header">
                      <tr>
                        <th pSortableColumn="nombre" class="bg-gray-50 px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                          Nombre
                          <p-sortIcon field="nombre"></p-sortIcon>
                        </th>
                        <th class="bg-gray-50 px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                          Direcci√≥n
                        </th>
                        <th class="bg-gray-50 px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                          Estado
                        </th>
                        <th class="bg-gray-50 px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                          Presupuesto
                        </th>
                        <th class="bg-gray-50 px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                          Acciones
                        </th>
                      </tr>
                    </ng-template>

                    <ng-template pTemplate="body" let-obra>
                      <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap">
                          <div class="flex items-center gap-2">
                            <i class="pi pi-building text-cyan-600"></i>
                            <strong class="text-gray-900">{{ obra.nombre }}</strong>
                          </div>
                        </td>
                        <td class="px-6 py-4 text-gray-600">{{ obra.direccion || '‚Äî' }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                          <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                            {{ obra.obra_estado?.nombre || 'Sin estado' }}
                          </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right font-semibold text-gray-900">
                          {{ obra.presupuesto | currency:'ARS':'symbol':'1.0-2' }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">
                          <p-button
                            icon="pi pi-eye"
                            [text]="true"
                            [rounded]="true"
                            severity="info"
                            pTooltip="Ver detalle"
                            tooltipPosition="left"
                            (onClick)="verObra(obra)"
                          ></p-button>
                        </td>
                      </tr>
                    </ng-template>

                    <ng-template pTemplate="emptymessage">
                      <tr>
                        <td colspan="5" class="text-center py-8 text-gray-500">
                          <i class="pi pi-inbox text-4xl mb-2"></i>
                          <p>No hay obras asignadas</p>
                        </td>
                      </tr>
                    </ng-template>
                  </p-table>
                </div>
              } @else {
                <div class="text-center py-12 text-gray-500">
                  <i class="pi pi-inbox text-5xl mb-3"></i>
                  <p class="text-lg font-medium text-gray-500">No hay obras registradas</p>
                  <p class="text-sm text-gray-400">Este cliente a√∫n no tiene obras asociadas</p>
                </div>
              }
            </p-tabpanel>

            <!-- TAB: DOCUMENTOS -->
            <p-tabpanel value="1">
              @defer (when cliente) {
                <app-clientes-documentos [clienteId]="cliente.id!"></app-clientes-documentos>
              } @placeholder {
                <div class="flex justify-center items-center min-h-[40vh]">
                  <p-progressSpinner pStyleClass="w-12 h-12" strokeWidth="4" animationDuration=".8s"></p-progressSpinner>
                </div>
              }
            </p-tabpanel>
          </p-tabpanels>
        </p-tabs>
      </div>

      <!-- ===================== GESTI√ìN DE ESTADO ===================== -->
      <div class="mx-4 bg-white rounded-xl shadow-md p-6 mt-5">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-4">
            <div class="w-12 h-12 rounded-lg flex items-center justify-center"
                 [ngClass]="cliente.activo ? 'bg-green-100' : 'bg-red-100'">
              <i class="text-xl"
                 [ngClass]="cliente.activo ? 'pi pi-check-circle text-green-600' : 'pi pi-times-circle text-red-600'">
              </i>
            </div>
            <div>
              <p class="text-sm font-medium text-gray-500 mb-1">Estado del Cliente</p>
              <p class="text-sm text-gray-600">
                {{ cliente.activo ? 'Cliente activo en el sistema' : 'Cliente desactivado' }}
              </p>
            </div>
          </div>
          <p-button
            [icon]="cliente.activo ? 'pi pi-ban' : 'pi pi-check'"
            [label]="cliente.activo ? 'Desactivar' : 'Activar'"
            [severity]="cliente.activo ? 'danger' : 'success'"
            [outlined]="true"
            [pTooltip]="cliente.activo ? 'Desactivar este cliente' : 'Activar este cliente'"
            tooltipPosition="top"
            (onClick)="toggleActivo()">
          </p-button>
        </div>
      </div>
  } @placeholder {
    <!-- ü¶¥ Skeleton Mejorado -->
    <div class="p-8 space-y-8 max-w-full mx-auto">
      <!-- Tarjetas skeleton -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        @for (item of [1,2,3,4]; track item) {
          <div class="bg-white rounded-xl shadow-md p-6 animate-pulse">
            <div class="flex items-center gap-3 mb-2">
              <div class="w-10 h-10 bg-gray-200 rounded-lg"></div>
              <div class="h-4 bg-gray-200 rounded w-16"></div>
            </div>
            <div class="h-6 bg-gray-200 rounded w-3/4"></div>
          </div>
        }
      </div>

      <!-- Estad√≠sticas skeleton -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="bg-gradient-to-br from-gray-300 to-gray-400 rounded-xl shadow-md p-6 animate-pulse">
          <div class="h-6 bg-white/30 rounded w-1/2 mb-4"></div>
          <div class="h-16 bg-white/30 rounded"></div>
        </div>
        <div class="bg-gradient-to-br from-gray-300 to-gray-400 rounded-xl shadow-md p-6 animate-pulse">
          <div class="h-6 bg-white/30 rounded w-1/2 mb-4"></div>
          <div class="h-16 bg-white/30 rounded"></div>
        </div>
        <div class="bg-gradient-to-br from-gray-300 to-gray-400 rounded-xl shadow-md p-6 animate-pulse">
          <div class="h-6 bg-white/30 rounded w-1/2 mb-4"></div>
          <div class="h-16 bg-white/30 rounded"></div>
        </div>
      </div>

      <!-- Resumen skeleton -->
      <div class="bg-white rounded-xl shadow-md p-6 animate-pulse">
        <div class="h-6 bg-gray-200 rounded w-1/4 mb-4"></div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <div class="h-20 bg-gray-100 rounded-lg"></div>
          <div class="h-20 bg-gray-100 rounded-lg"></div>
          <div class="h-20 bg-gray-100 rounded-lg"></div>
          <div class="h-20 bg-gray-100 rounded-lg"></div>
        </div>
      </div>
    </div>
  }
}
