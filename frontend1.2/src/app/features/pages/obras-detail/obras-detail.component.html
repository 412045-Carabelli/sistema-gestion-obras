<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

@if (loading) {
  <div class="flex justify-center items-center min-h-[60vh]">
    <p-progressSpinner styleClass="w-16 h-16" strokeWidth="4" animationDuration=".8s"></p-progressSpinner>
  </div>
} @else {
  @defer (when obra) {
    <div class="p-4 space-y-8 w-full mx-auto">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <h1 class="text-2xl font-semibold text-gray-900">Resumen de la obra</h1>
          <p class="text-gray-600">Datos completos de {{ obra.nombre }}</p>
        </div>
        <p-button
          icon="pi pi-file-pdf"
          label="Exportar PDF"
          severity="danger"
          (onClick)="exportarResumenPdf()">
        </p-button>
      </div>

      <!-- ===================== TARJETAS DE INFO PRINCIPAL ===================== -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">

        <!-- Tarjeta Cliente -->
        <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-blue-500">
          <div class="flex items-center gap-3 mb-2">
            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
              <i class="pi pi-user text-blue-600 text-lg"></i>
            </div>
            <span class="text-sm font-medium text-gray-500">Cliente</span>
          </div>
          <p class="text-lg font-semibold text-gray-900">{{ obra.cliente.nombre }}</p>
        </div>

        <!-- Tarjeta Presupuesto -->
        <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-green-500">
          <div class="flex items-center gap-3 mb-2">
            <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
              <i class="pi pi-dollar text-green-600 text-lg"></i>
            </div>
            <span class="text-sm font-medium text-gray-500">Presupuesto</span>
          </div>
          <p class="text-lg font-semibold text-gray-900">{{ obra.presupuesto | currency:'ARS' }}</p>
        </div>

        <!-- Tarjeta Costos -->
        <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-purple-500">
          <div class="flex items-center gap-3 mb-2">
            <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
              <i class="pi pi-wallet text-purple-600 text-lg"></i>
            </div>
            <span class="text-sm font-medium text-gray-500">Costos</span>
          </div>
          <p class="text-lg font-semibold text-gray-900">{{ totalCostosBase | currency:'ARS' }}</p>
          <p class="text-xs text-gray-600">Subtotal sin beneficio</p>
        </div>

        <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-emerald-500">
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-emerald-100 rounded-lg flex items-center justify-center">
                <i class="pi pi-chart-line text-emerald-600 text-lg"></i>
              </div>
            <span class="text-sm font-medium text-gray-500">Beneficio</span>
            </div>
            <i class="pi pi-info-circle text-gray-400 cursor-pointer"
               pTooltip="Suma de los beneficios aplicados a cada costo (global o individual)."
               tooltipPosition="left"></i>
          </div>
          <p class="text-lg font-semibold" [ngClass]="beneficioNeto >= 0 ? 'text-emerald-700' : 'text-red-600'">
            {{ beneficioNeto | currency:'ARS' }}
          </p>
          <p class="text-xs text-gray-500">Actualizado con la matriz de costos</p>
        </div>
        <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-orange-500">
          <div class="flex items-center gap-3 mb-2">
            <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center">
              <i class="pi pi-flag text-orange-600 text-lg"></i>
            </div>
            <span class="text-sm font-medium text-gray-500">Estado</span>
          </div>
          <p-select
            [options]="estadosObra"
            [(ngModel)]="estadoSeleccionado"
            (onChange)="actualizarEstadoObra($event.value)"
            appendTo="body"
            optionLabel="label"
            optionValue="name"
            styleClass="w-full text-sm">
          </p-select>
        </div>

      </div>


      <!-- ===================== FECHAS Y PROGRESO ===================== -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- Fechas -->
        <div class="lg:col-span-2 bg-white rounded-xl shadow-md p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
            <i class="pi pi-calendar text-blue-600"></i>
            Cronograma
            @if (cronogramaFueraDeRango) {
              <span class="ml-2 px-2 py-1 text-xs font-semibold text-white bg-red-500 rounded-full">Fuera de rango</span>
            }
          </h3>
          <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
            <div class="flex items-center gap-3 p-4 bg-gray-50 rounded-lg">
              <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
                <i class="pi pi-calendar-plus text-blue-600"></i>
              </div>
              <div>
                <p class="text-xs text-gray-500 mb-1">Fecha de inicio</p>
                <p class="font-semibold text-gray-900">{{ obra.fecha_inicio | date:'dd/MM/yyyy' }}</p>
              </div>
            </div>
            <div class="flex items-center gap-3 p-4 bg-gray-50 rounded-lg">
              <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0">
                <i class="pi pi-calendar-times text-red-600"></i>
              </div>
              <div>
                <p class="text-xs text-gray-500 mb-1">Fecha de fin</p>
                <p class="font-semibold text-gray-900">
                  {{ obra.fecha_fin ? (obra.fecha_fin | date:'dd/MM/yyyy') : 'Sin definir' }}
                </p>
                @if (cronogramaFueraDeRango) {
                  <p class="text-xs text-red-600 font-semibold">La fecha fin es anterior al inicio.</p>
                }
              </div>
            </div>
            <div class="flex items-center gap-3 p-4 bg-gray-50 rounded-lg">
              <div class="w-12 h-12 bg-amber-100 rounded-full flex items-center justify-center flex-shrink-0">
                <i class="pi pi-clock text-amber-600"></i>
              </div>
              <div>
                <p class="text-xs text-gray-500 mb-1">Fecha presupuestado</p>
                <p class="font-semibold text-gray-900">
                  {{ obra.fecha_presupuesto ? (obra.fecha_presupuesto | date:'dd/MM/yyyy') : 'Sin definir' }}
                </p>
              </div>
            </div>
            <div class="flex items-center gap-3 p-4 bg-gray-50 rounded-lg">
              <div class="w-12 h-12 bg-emerald-100 rounded-full flex items-center justify-center flex-shrink-0">
                <i class="pi pi-verified text-emerald-600"></i>
              </div>
              <div>
                <p class="text-xs text-gray-500 mb-1">Fecha adjudicada</p>
                <p class="font-semibold text-gray-900">
                  {{ obra.fecha_adjudicada ? (obra.fecha_adjudicada | date:'dd/MM/yyyy') : 'Sin adjudicar' }}
                </p>
              </div>
            </div>
            <div class="flex items-center gap-3 p-4 bg-gray-50 rounded-lg">
              <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0">
                <i class="pi pi-times text-red-600"></i>
              </div>
              <div>
                <p class="text-xs text-gray-500 mb-1">Fecha perdida</p>
                <p class="font-semibold text-gray-900">
                  {{ obra.fecha_perdida ? (obra.fecha_perdida | date:'dd/MM/yyyy') : 'Sin perdida' }}
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Progreso Físico -->
        <div class="bg-gradient-to-br from-blue-500 to-blue-700 rounded-xl shadow-md p-6 text-white">
          <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
            <i class="pi pi-chart-line"></i>
            Progreso Físico
          </h3>
          <div class="relative">
            <p-progressBar
              [value]="progresoFisico"
              [showValue]="false"
              styleClass="h-3">
            </p-progressBar>
            <div class="mt-3 text-center">
              <p class="text-4xl font-bold">{{ progresoFisico }}%</p>
              <p class="text-sm text-blue-100 mt-1">completado</p>
            </div>
          </div>
        </div>
      </div>

      <!-- ===================== TABS MEJORADOS ===================== -->
      <div class="bg-white rounded-xl shadow-md overflow-hidden">
        <p-tabs value="0">
          <p-tablist pStyleClass="border-b border-gray-200 px-6">
            <p-tab value="0" pStyleClass="px-6 py-4">
              <div class="flex items-center gap-3">
                <i class="pi pi-calculator"></i>
                <div class="flex flex-col leading-tight">
                  <span class="font-semibold text-sm">Presupuesto</span>
                  <span class="text-xs text-gray-500">Costos y beneficios</span>
                </div>
              </div>
            </p-tab>
            <p-tab value="1" pStyleClass="px-6 py-4">
              <div class="flex items-center gap-3">
                <i class="pi pi-list-check"></i>
                <div class="flex flex-col leading-tight">
                  <span class="font-semibold text-sm">Tareas</span>
                  <span class="text-xs text-gray-500">Planificacion y avance</span>
                </div>
              </div>
            </p-tab>
            <p-tab value="2" pStyleClass="px-6 py-4">
              <div class="flex items-center gap-3">
                <i class="pi pi-arrow-right-arrow-left"></i>
                <div class="flex flex-col leading-tight">
                  <span class="font-semibold text-sm">Movimientos</span>
                  <span class="text-xs text-gray-500">Cobros y pagos</span>
                </div>
              </div>
            </p-tab>
            <p-tab value="3" pStyleClass="px-6 py-4">
              <div class="flex items-center gap-3">
                <i class="pi pi-file"></i>
                <div class="flex flex-col leading-tight">
                  <span class="font-semibold text-sm">Facturas</span>
                  <span class="text-xs text-gray-500">Documentos de la obra</span>
                </div>
              </div>
            </p-tab>
            <p-tab value="4" pStyleClass="px-6 py-4">
              <div class="flex items-center gap-3">
                <i class="pi pi-align-left"></i>
                <div class="flex flex-col leading-tight">
                  <span class="font-semibold text-sm">Notas y documentos</span>
                  <span class="text-xs text-gray-500">Notas, memoria y archivos</span>
                </div>
              </div>
            </p-tab>
          </p-tablist>

          <p-tabpanels pStyleClass="p-6">
            <p-tabpanel value="1">
              <app-obra-tareas
                [obraId]="obra.id!"
                [obraNombre]="obra.nombre"
                [proveedores]="proveedores"
                [tareas]="tareas"
                (tareasActualizadas)="onTareasActualizadas($event)">
              </app-obra-tareas>
            </p-tabpanel>

            <p-tabpanel value="0">
              <app-obra-presupuesto
                [obra]="obra!"
                [proveedores]="proveedores"
                [costos]="obra.costos!"
                [usarBeneficioGlobal]="obra.beneficio_global ?? false"
                [beneficioGlobal]="obra.beneficio ?? 0"
                [tieneComision]="obra.tiene_comision ?? false"
                [comision]="obra.comision ?? 0"
                (costosActualizados)="onCostosActualizados($event)"
                (movimientoCreado)="refrescarMovimientos()">
              </app-obra-presupuesto>
            </p-tabpanel>

            <p-tabpanel value="2">
              <app-obra-movimientos
                #movimientosRef
                [clientes]="[obra.cliente]"
                [proveedores]="proveedores"
                [obraId]="obra.id!"
                [obraNombre]="obra.nombre"
                [presupuestoTotal]="obra.presupuesto ?? 0"
                (costosActualizados)="onCostosActualizados($event)"
              >
              </app-obra-movimientos>
            </p-tabpanel>

            <p-tabpanel value="3">
              <div class="p-4 space-y-5">
                <div class="flex justify-between items-center flex-wrap gap-3">
                  <div>
                    <h2 class="text-2xl font-bold text-gray-900">Facturas</h2>
                    <p class="text-gray-500 text-sm mt-1">
                      Facturas asociadas a la obra
                    </p>
                  </div>

                  <p-button
                    (onClick)="abrirFacturaModal()"
                    icon="pi pi-plus"
                    label="Nueva Factura"
                    styleClass="p-button-md p-button-primary"
                  ></p-button>
                </div>

                @if (facturasFiltradas.length > 0) {
                  <p-table
                    [value]="facturasFiltradas"
                    [sortField]="'fecha'"
                    [sortOrder]="-1"
                    responsiveLayout="scroll"
                    class="text-sm p-datatable-sm border border-gray-200 rounded-lg overflow-hidden"
                  >
                    <ng-template pTemplate="header">
                      <tr class="bg-gray-50 text-gray-700">
                        <th pSortableColumn="fecha">
                          Fecha
                          <p-sortIcon field="fecha"></p-sortIcon>
                        </th>
                        <th>Descripcion</th>
                        <th>Estado</th>
                        <th>Monto</th>
                        <th>Archivo</th>
                      </tr>
                    </ng-template>

                    <ng-template pTemplate="body" let-f let-rowIndex="rowIndex">
                      <tr
                        class="hover:bg-emerald-50 hover:shadow-sm transition cursor-pointer"
                        [ngClass]="rowIndex % 2 === 0 ? 'bg-white' : 'bg-gray-50'"
                        (click)="abrirDetalleFactura(f)"
                      >
                        <td>{{ f.fecha | date: 'dd/MM/yyyy' }}</td>
                        <td class="text-gray-700">
                          {{ stripFacturaDescripcion(f.descripcion) || '—' }}
                        </td>
                        <td>
                          <p-tag
                            [value]="f.estado || 'EMITIDA'"
                            [severity]="(f.estado || 'EMITIDA') === 'COBRADA' ? 'success' : 'info'">
                          </p-tag>
                        </td>
                        <td class="font-semibold text-gray-900">
                          <div class="flex justify-start">{{ f.monto | currency: 'ARS' }}</div>
                        </td>
                        <td class="text-gray-600">{{ f.nombre_archivo || 'Sin archivo' }}</td>
                      </tr>
                    </ng-template>
                  </p-table>

                  <div class="mt-4 p-4 bg-gray-50 rounded-lg text-sm space-y-1">
                    <div class="flex justify-between font-semibold">
                      <span>Total facturado:</span>
                      <span class="flex justify-start">{{ totalFacturasMonto | currency: 'ARS' }}</span>
                    </div>
                    <div class="flex justify-between text-sm text-gray-700 border-t pt-2">
                      <span>Cantidad de facturas</span>
                      <span>{{ facturasFiltradas.length }}</span>
                    </div>
                  </div>
                } @else {
                  <div class="text-center text-gray-500 py-10 flex flex-col items-center gap-2">
                    <i class="pi pi-inbox text-4xl"></i>
                    <p>No hay facturas registradas para esta obra.</p>
                  </div>
                }

              </div>

              <app-modal
                (closed)="cerrarFacturaModal()"
                (confirmed)="guardarFacturaObra()"
                [title]="'Nueva factura'"
                [visible]="showFacturaModal"
              >
                <div class="p-3 space-y-3">
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                      <label class="block text-sm font-medium mb-1 text-gray-700">Obra</label>
                      <input
                        type="text"
                        class="w-full border rounded-md px-3 py-2 text-sm bg-gray-50"
                        [value]="obra.nombre"
                        readonly
                      />
                    </div>
                    <div>
                      <label class="block text-sm font-medium mb-1 text-gray-700">Cliente</label>
                      <input
                        type="text"
                        class="w-full border rounded-md px-3 py-2 text-sm bg-gray-50"
                        [value]="obra.cliente.nombre"
                        readonly
                      />
                    </div>
                  </div>

                  <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                      <label class="block text-sm font-medium mb-1 text-gray-700">Fecha</label>
                      <p-datepicker
                        [(ngModel)]="facturaForm.fecha"
                        appendTo="body"
                        class="w-full"
                        dateFormat="dd/mm/yy"
                      ></p-datepicker>
                    </div>
                    <div>
                      <label class="block text-sm font-medium mb-1 text-gray-700">Monto</label>
                      <p-inputNumber
                        [(ngModel)]="facturaForm.monto"
                        class="w-full"
                        mode="decimal"
                        locale="es-AR"
                      ></p-inputNumber>
                      <p class="text-xs text-gray-500 mt-1">
                        Restante por facturar: {{ (obra.presupuesto ?? 0) - totalFacturasMonto | currency:'ARS' }}
                      </p>
                    </div>
                  </div>

                  <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                      <label class="block text-sm font-medium mb-1 text-gray-700">Estado</label>
                      <p-select
                        [(ngModel)]="facturaForm.estado"
                        [options]="[
                          { label: 'Emitida', value: 'EMITIDA' },
                          { label: 'Cobrada', value: 'COBRADA' }
                        ]"
                        optionLabel="label"
                        optionValue="value"
                        appendTo="body"
                        class="w-full"
                      ></p-select>
                    </div>
                  </div>

                  <div>
                    <label class="block text-sm font-medium mb-1 text-gray-700">Descripcion</label>
                    <p-editor
                      [(ngModel)]="facturaForm.descripcion"
                      [style]="{ height: '180px' }"
                    ></p-editor>
                  </div>

                  <div>
                    <label class="block text-sm font-medium mb-1 text-gray-700">Adjuntar factura (opcional)</label>
                    <p-fileUpload
                      mode="basic"
                      chooseLabel="Seleccionar archivo"
                      chooseIcon="pi pi-upload"
                      accept=".jpg,.jpeg,.png,.pdf"
                      [auto]="false"
                      (onSelect)="onFacturaFileSelected($event)"
                    ></p-fileUpload>
                    @if (facturaFile) {
                      <div class="flex items-center gap-2 text-sm text-gray-700 mt-2">
                        <span>{{ facturaFile.name }}</span>
                        <button type="button" class="text-red-500 hover:text-red-700" (click)="quitarFacturaArchivo()">x</button>
                      </div>
                    }
                  </div>
                </div>
              </app-modal>

              <app-modal
                [visible]="showFacturaDetalleModal"
                [title]="'Detalle de factura'"
                [showFooter]="false"
                (closed)="cerrarDetalleFactura()"
              >
                <div class="p-3 space-y-4">
                  @if (facturaDetalle) {
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div class="flex flex-col gap-2">
                        <label class="text-sm font-medium text-gray-700">Fecha</label>
                        <input
                          class="p-inputtext p-component w-full"
                          [value]="(facturaDetalle.fecha | date:'dd/MM/yyyy') || ''"
                          disabled
                          type="text"/>
                      </div>
                      <div class="flex flex-col gap-2">
                        <label class="text-sm font-medium text-gray-700">Estado</label>
                        <input
                          class="p-inputtext p-component w-full"
                          [value]="facturaDetalle.estado || 'EMITIDA'"
                          disabled
                          type="text"/>
                      </div>
                      <div class="flex flex-col gap-2 md:col-span-2">
                        <label class="text-sm font-medium text-gray-700">Descripcion</label>
                        <textarea
                          class="p-inputtext p-component w-full h-24 resize-none"
                          [value]="stripFacturaDescripcion(facturaDetalle.descripcion) || ''"
                          disabled></textarea>
                      </div>
                      <div class="flex flex-col gap-2">
                        <label class="text-sm font-medium text-gray-700">Monto</label>
                        <input
                          class="p-inputtext p-component w-full"
                          [value]="(facturaDetalle.monto | currency:'ARS':'symbol':'1.0-2') || ''"
                          disabled
                          type="text"/>
                      </div>
                      <div class="flex flex-col gap-2">
                        <label class="text-sm font-medium text-gray-700">Archivo</label>
                        <input
                          class="p-inputtext p-component w-full"
                          [value]="facturaDetalle.nombre_archivo || 'Sin archivo'"
                          disabled
                          type="text"/>
                      </div>
                    </div>

                    <div class="flex justify-end gap-2">
                      <p-button label="Cerrar" icon="pi pi-times" (onClick)="cerrarDetalleFactura()"></p-button>
                      <p-button label="Editar" icon="pi pi-pencil" (onClick)="editarFacturaDetalle()"></p-button>
                      <p-button
                        label="Eliminar"
                        icon="pi pi-trash"
                        severity="danger"
                        (onClick)="eliminarFacturaDetalle()">
                      </p-button>
                    </div>
                  }
                </div>
              </app-modal>
            </p-tabpanel>

            <p-tabpanel value="4">
              <div class="flex flex-col gap-6">
                <app-obra-documentos
                  [obraId]="obra.id!"
                  [proveedores]="proveedores"
                  [clientes]="[obra.cliente]"
                ></app-obra-documentos>

                <div class="flex flex-col lg:flex-row items-stretch gap-6">
                <div class="bg-white rounded-xl shadow-md p-6 flex-1 h-full flex flex-col">
                  <h3 class="text-lg font-semibold text-gray-900 mb-3 flex items-center gap-2">
                    <i class="pi pi-file-edit text-gray-600"></i>
                    Notas y Observaciones
                  </h3>
                  <div class="p-4 rounded-lg bg-amber-50 border border-amber-200 text-gray-800 min-h-[4rem] relative flex-1">
                    @if (obra.notas?.trim()) {
                      <div
                        #notasBody
                        class="notas-body"
                        [ngClass]="{ 'notas-collapsed': !notasExpandida }"
                      >
                        {{ obra.notas?.trim() }}
                      </div>
                      @if (notasOverflow) {
                        <button
                          type="button"
                          class="text-sm text-amber-700 font-semibold absolute bottom-3 right-4"
                          (click)="toggleNotas()"
                        >
                          {{ notasExpandida ? 'Ver menos' : 'Ver mas' }}
                        </button>
                      }
                    } @else {
                      <div class="text-gray-700 flex items-center h-full">
                        Sin notas registradas
                      </div>
                    }
                  </div>
                </div>

                <div class="bg-white rounded-xl shadow-md p-6 flex-1">
                  <h3 class="text-lg font-semibold text-gray-900 mb-3 flex items-center gap-2">
                    <i class="pi pi-align-left text-gray-600"></i>
                    Memoria Descriptiva
                  </h3>
                  @if (obra.memoria_descriptiva?.trim()) {
                    <div class="p-4 rounded-lg bg-blue-50 border border-blue-200 text-gray-800 memoria-view">
                      <div
                        class="memoria-body"
                        [ngClass]="{ 'memoria-collapsed': !memoriaExpandida }"
                        [innerHTML]="obra.memoria_descriptiva"
                      ></div>
                      <button
                        type="button"
                        class="text-sm text-blue-700 font-semibold mt-3"
                        (click)="toggleMemoria()"
                      >
                        {{ memoriaExpandida ? 'Ver menos' : 'Ver mas' }}
                      </button>
                    </div>
                  } @else {
                    <div class="p-4 rounded-lg bg-blue-50 border border-blue-200 text-gray-700 min-h-[4rem] flex items-center">
                      Sin memoria descriptiva registrada
                    </div>
                  }
                </div>
              </div>
            </div>
            </p-tabpanel>

          </p-tabpanels>
        </p-tabs>
      </div>

      <app-modal
        [visible]="showEstadoFechaModal"
        [title]="estadoFechaModalTitle"
        [showFooter]="false"
        (closed)="cancelarCambioEstado()"
      >
        <div class="p-3 space-y-4">
          <p class="text-sm text-gray-600">
            Selecciona la fecha para confirmar el cambio de estado.
          </p>
          <div class="flex flex-col gap-2">
            <label class="text-sm font-medium text-gray-700">{{ estadoFechaLabel }}</label>
            <p-datepicker
              [(ngModel)]="fechaEstadoSeleccionada"
              appendTo="body"
              class="w-full"
              dateFormat="dd/mm/yy"
              [showIcon]="true"
            ></p-datepicker>
          </div>
          <div class="flex justify-end gap-2">
            <p-button label="Cancelar" icon="pi pi-times" (onClick)="cancelarCambioEstado()"></p-button>
            <p-button label="Guardar" icon="pi pi-check" (onClick)="confirmarCambioEstadoConFecha()"></p-button>
          </div>
        </div>
      </app-modal>

      <!-- ===================== GESTIÓN DE ESTADO ===================== -->
      <div class="bg-white rounded-xl shadow-md p-6 mt-5 w-full">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-4">
            <div class="w-12 h-12 rounded-lg flex items-center justify-center"
                 [ngClass]="obra.activo ? 'bg-green-100' : 'bg-red-100'">
              <i class="text-xl"
                 [ngClass]="obra.activo ? 'pi pi-check-circle text-green-600' : 'pi pi-times-circle text-red-600'">
              </i>
            </div>
            <div>
              <p class="text-sm font-medium text-gray-500 mb-1">Estado de la Obra</p>
              <p class="text-sm text-gray-600">
                {{ obra.activo ? 'Obra activa en el sistema' : 'Obra desactivado' }}
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  } @placeholder {
    <!-- 🦴 Skeleton Mejorado -->
    <div class="p-8 space-y-8 max-w-6xl mx-auto">
      <!-- Header skeleton -->
      <div class="bg-gradient-to-r from-gray-300 to-gray-400 rounded-2xl p-8 animate-pulse">
        <div class="space-y-3">
          <div class="h-8 bg-white/30 rounded w-1/3"></div>
          <div class="h-4 bg-white/30 rounded w-1/4"></div>
        </div>
      </div>

      <!-- Tarjetas skeleton -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        @for (item of [1,2,3,4]; track item) {
          <div class="bg-white rounded-xl shadow-md p-6 animate-pulse">
            <div class="flex items-center gap-3 mb-2">
              <div class="w-10 h-10 bg-gray-200 rounded-lg"></div>
              <div class="h-4 bg-gray-200 rounded w-16"></div>
            </div>
            <div class="h-6 bg-gray-200 rounded w-3/4"></div>
          </div>
        }
      </div>

      <!-- Fechas y progreso skeleton -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 bg-white rounded-xl shadow-md p-6 animate-pulse">
          <div class="h-6 bg-gray-200 rounded w-1/4 mb-4"></div>
          <div class="grid grid-cols-2 gap-4">
            <div class="h-20 bg-gray-100 rounded-lg"></div>
            <div class="h-20 bg-gray-100 rounded-lg"></div>
          </div>
        </div>
        <div class="bg-gradient-to-br from-gray-300 to-gray-400 rounded-xl shadow-md p-6 animate-pulse">
          <div class="h-6 bg-white/30 rounded w-1/2 mb-4"></div>
          <div class="h-16 bg-white/30 rounded"></div>
        </div>
      </div>
    </div>
  }
}


