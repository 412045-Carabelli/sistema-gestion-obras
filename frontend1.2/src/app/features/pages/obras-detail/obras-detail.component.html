<p-toast></p-toast>

@if (loading) {
  <div class="flex justify-center items-center min-h-[60vh]">
    <p-progressSpinner styleClass="w-16 h-16" strokeWidth="4" animationDuration=".8s"></p-progressSpinner>
  </div>
} @else {
  @defer (when obra) {
    <div class="p-4 space-y-8 w-full mx-auto">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <h1 class="text-2xl font-semibold text-gray-900">Resumen de la obra</h1>
          <p class="text-gray-600">Datos completos de {{ obra.nombre }}</p>
        </div>
        <p-button
          icon="pi pi-file-pdf"
          label="Exportar PDF"
          severity="danger"
          (onClick)="exportarResumenPdf()">
        </p-button>
      </div>

      <!-- ===================== TARJETAS DE INFO PRINCIPAL ===================== -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">

        <!-- Tarjeta Cliente -->
        <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-blue-500 hover:shadow-lg transition-shadow">
          <div class="flex items-center gap-3 mb-2">
            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
              <i class="pi pi-user text-blue-600 text-lg"></i>
            </div>
            <span class="text-sm font-medium text-gray-500">Cliente</span>
          </div>
          <p class="text-lg font-semibold text-gray-900">{{ obra.cliente.nombre }}</p>
        </div>

        <!-- Tarjeta Presupuesto -->
        <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-green-500 hover:shadow-lg transition-shadow">
          <div class="flex items-center gap-3 mb-2">
            <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
              <i class="pi pi-dollar text-green-600 text-lg"></i>
            </div>
            <span class="text-sm font-medium text-gray-500">Presupuesto</span>
          </div>
          <p class="text-lg font-semibold text-gray-900">{{ obra.presupuesto | currency:'ARS' }}</p>
        </div>

        <!-- Tarjeta Comision -->
        <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-purple-500 hover:shadow-lg transition-shadow">
          <div class="flex items-center gap-3 mb-2">
            <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
              <i class="pi pi-percentage text-purple-600 text-lg"></i>
            </div>
            <span class="text-sm font-medium text-gray-500">Comision</span>
          </div>
          <div class="space-y-1">
            <p class="text-lg font-semibold text-gray-900">
              {{ obra.comision != null ? (obra.comision + '%') : 'Sin comision' }}
            </p>
            <p class="text-sm text-gray-600">
              {{ ((obra.presupuesto || 0) * ((obra.comision || 0) / 100)) | currency:'ARS' }}
            </p>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-emerald-500 hover:shadow-lg transition-shadow">
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-emerald-100 rounded-lg flex items-center justify-center">
                <i class="pi pi-chart-line text-emerald-600 text-lg"></i>
              </div>
              <span class="text-sm font-medium text-gray-500">Beneficio (costos)</span>
            </div>
            <i class="pi pi-info-circle text-gray-400 cursor-pointer"
               pTooltip="Suma de los beneficios aplicados a cada costo (global o individual)."
               tooltipPosition="left"></i>
          </div>
          <p class="text-lg font-semibold" [ngClass]="beneficioNeto >= 0 ? 'text-emerald-700' : 'text-red-600'">
            {{ beneficioNeto | currency:'ARS' }}
          </p>
          <p class="text-xs text-gray-500">Actualizado con la matriz de costos</p>
        </div>

        <!-- Tarjeta Estado -->
        <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-orange-500 hover:shadow-lg transition-shadow">
          <div class="flex items-center gap-3 mb-2">
            <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center">
              <i class="pi pi-flag text-orange-600 text-lg"></i>
            </div>
            <span class="text-sm font-medium text-gray-500">Estado</span>
          </div>
          <p-select
            [options]="estadosObra"
            [(ngModel)]="estadoSeleccionado"
            (onChange)="actualizarEstadoObra($event.value)"
            appendTo="body"
            optionLabel="label"
            optionValue="name"
            styleClass="w-full text-sm">
          </p-select>
        </div>
      </div>

      <!-- ===================== FECHAS Y PROGRESO ===================== -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- Fechas -->
        <div class="lg:col-span-2 bg-white rounded-xl shadow-md p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
            <i class="pi pi-calendar text-blue-600"></i>
            Cronograma
            @if (cronogramaFueraDeRango) {
              <span class="ml-2 px-2 py-1 text-xs font-semibold text-white bg-red-500 rounded-full">Fuera de rango</span>
            }
          </h3>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="flex items-center gap-3 p-4 bg-gray-50 rounded-lg">
              <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
                <i class="pi pi-calendar-plus text-blue-600"></i>
              </div>
              <div>
                <p class="text-xs text-gray-500 mb-1">Fecha de inicio</p>
                <p class="font-semibold text-gray-900">{{ obra.fecha_inicio | date:'dd/MM/yyyy' }}</p>
              </div>
            </div>
            <div class="flex items-center gap-3 p-4 bg-gray-50 rounded-lg">
              <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0">
                <i class="pi pi-calendar-times text-red-600"></i>
              </div>
              <div>
                <p class="text-xs text-gray-500 mb-1">Fecha de fin</p>
                <p class="font-semibold text-gray-900">
                  {{ obra.fecha_fin ? (obra.fecha_fin | date:'dd/MM/yyyy') : 'Sin definir' }}
                </p>
                @if (cronogramaFueraDeRango) {
                  <p class="text-xs text-red-600 font-semibold">La fecha fin es anterior al inicio.</p>
                }
              </div>
            </div>
            <div class="flex items-center gap-3 p-4 bg-gray-50 rounded-lg">
              <div class="w-12 h-12 bg-amber-100 rounded-full flex items-center justify-center flex-shrink-0">
                <i class="pi pi-clock text-amber-600"></i>
              </div>
              <div>
                <p class="text-xs text-gray-500 mb-1">Fecha presupuestado</p>
                <p class="font-semibold text-gray-900">
                  {{ obra.fecha_presupuesto ? (obra.fecha_presupuesto | date:'dd/MM/yyyy') : 'Sin definir' }}
                </p>
              </div>
            </div>
            <div class="flex items-center gap-3 p-4 bg-gray-50 rounded-lg">
              <div class="w-12 h-12 bg-emerald-100 rounded-full flex items-center justify-center flex-shrink-0">
                <i class="pi pi-verified text-emerald-600"></i>
              </div>
              <div>
                <p class="text-xs text-gray-500 mb-1">Fecha adjudicada</p>
                <p class="font-semibold text-gray-900">
                  {{ obra.fecha_adjudicada ? (obra.fecha_adjudicada | date:'dd/MM/yyyy') : 'Sin adjudicar' }}
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Progreso FÃ­sico -->
        <div class="bg-gradient-to-br from-blue-500 to-blue-700 rounded-xl shadow-md p-6 text-white">
          <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
            <i class="pi pi-chart-line"></i>
            Progreso Físico
          </h3>
          <div class="relative">
            <p-progressBar
              [value]="progresoFisico"
              [showValue]="false"
              styleClass="h-3">
            </p-progressBar>
            <div class="mt-3 text-center">
              <p class="text-4xl font-bold">{{ progresoFisico }}%</p>
              <p class="text-sm text-blue-100 mt-1">completado</p>
            </div>
          </div>
        </div>
      </div>

      <!-- ===================== NOTAS / OBSERVACIONES ===================== -->
      <div class="bg-white rounded-xl shadow-md p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-3 flex items-center gap-2">
          <i class="pi pi-file-edit text-gray-600"></i>
          Notas y Observaciones
        </h3>
        <div class="p-4 rounded-lg flex items-center bg-amber-50 border border-amber-200 text-gray-800 whitespace-pre-wrap min-h-[4rem]">
          <p>
            {{ obra.notas?.trim() || 'Sin notas registradas' }}
          </p>
        </div>
      </div>

      <!-- ===================== TABS MEJORADOS ===================== -->
      <div class="bg-white rounded-xl shadow-md overflow-hidden">
        <p-tabs value="0">
          <p-tablist pStyleClass="border-b border-gray-200 px-6">
            <p-tab value="0" pStyleClass="px-6 py-4">
              <div class="flex items-center gap-2">
                <i class="pi pi-list-check"></i>
                <span class="font-medium">Tareas</span>
              </div>
            </p-tab>
            <p-tab value="1" pStyleClass="px-6 py-4">
              <div class="flex items-center gap-2">
                <i class="pi pi-calculator"></i>
                <span class="font-medium">Presupuesto</span>
              </div>
            </p-tab>
            <p-tab value="2" pStyleClass="px-6 py-4">
              <div class="flex items-center gap-2">
                <i class="pi pi-arrow-right-arrow-left"></i>
                <span class="font-medium">Movimientos</span>
              </div>
            </p-tab>
            <p-tab value="3" pStyleClass="px-6 py-4">
              <div class="flex items-center gap-2">
                <i class="pi pi-file"></i>
                <span class="font-medium">Documentos</span>
              </div>
            </p-tab>
          </p-tablist>

          <p-tabpanels pStyleClass="p-6">
            <p-tabpanel value="0">
              <app-obra-tareas
                [obraId]="obra.id!"
                [obraNombre]="obra.nombre"
                [proveedores]="proveedores"
                [tareas]="tareas"
                (tareasActualizadas)="onTareasActualizadas($event)">
              </app-obra-tareas>
            </p-tabpanel>

            <p-tabpanel value="1">
              <app-obra-presupuesto
                [obra]="obra!"
                [proveedores]="proveedores"
                [costos]="obra.costos!"
                [usarBeneficioGlobal]="obra.beneficio_global ?? false"
                [beneficioGlobal]="obra.beneficio ?? 0"
                [tieneComision]="obra.tiene_comision ?? false"
                [comision]="obra.comision ?? 0"
                (costosActualizados)="onCostosActualizados($event)"
                (movimientoCreado)="refrescarMovimientos()">
              </app-obra-presupuesto>
            </p-tabpanel>

            <p-tabpanel value="2">
              <app-obra-movimientos
                #movimientosRef
                [clientes]="[obra.cliente]"
                [proveedores]="proveedores"
                [obraId]="obra.id!"
                [obraNombre]="obra.nombre"
              >
              </app-obra-movimientos>
            </p-tabpanel>

            <p-tabpanel value="3">
              <app-obra-documentos
                [obraId]="obra.id!"
                [proveedores]="proveedores"
                [clientes]="[obra.cliente]"
              ></app-obra-documentos>
            </p-tabpanel>

          </p-tabpanels>
        </p-tabs>
      </div>

      <!-- ===================== GESTIÃ“N DE ESTADO ===================== -->
      <div class="bg-white rounded-xl shadow-md p-6 mt-5 w-full">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-4">
            <div class="w-12 h-12 rounded-lg flex items-center justify-center"
                 [ngClass]="obra.activo ? 'bg-green-100' : 'bg-red-100'">
              <i class="text-xl"
                 [ngClass]="obra.activo ? 'pi pi-check-circle text-green-600' : 'pi pi-times-circle text-red-600'">
              </i>
            </div>
            <div>
              <p class="text-sm font-medium text-gray-500 mb-1">Estado de la Obra</p>
              <p class="text-sm text-gray-600">
                {{ obra.activo ? 'Obra activa en el sistema' : 'Obra desactivado' }}
              </p>
            </div>
          </div>
          <p-button
            [icon]="obra.activo ? 'pi pi-ban' : 'pi pi-check'"
            [label]="obra.activo ? 'Desactivar' : 'Activar'"
            [severity]="obra.activo ? 'danger' : 'success'"
            [outlined]="true"
            [pTooltip]="obra.activo ? 'Desactivar esta obra' : 'Activar esta obra'"
            tooltipPosition="top"
            (onClick)="toggleActivo()">
          </p-button>
        </div>
      </div>
    </div>
  } @placeholder {
    <!-- ðŸ¦´ Skeleton Mejorado -->
    <div class="p-8 space-y-8 max-w-6xl mx-auto">
      <!-- Header skeleton -->
      <div class="bg-gradient-to-r from-gray-300 to-gray-400 rounded-2xl p-8 animate-pulse">
        <div class="space-y-3">
          <div class="h-8 bg-white/30 rounded w-1/3"></div>
          <div class="h-4 bg-white/30 rounded w-1/4"></div>
        </div>
      </div>

      <!-- Tarjetas skeleton -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        @for (item of [1,2,3,4]; track item) {
          <div class="bg-white rounded-xl shadow-md p-6 animate-pulse">
            <div class="flex items-center gap-3 mb-2">
              <div class="w-10 h-10 bg-gray-200 rounded-lg"></div>
              <div class="h-4 bg-gray-200 rounded w-16"></div>
            </div>
            <div class="h-6 bg-gray-200 rounded w-3/4"></div>
          </div>
        }
      </div>

      <!-- Fechas y progreso skeleton -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 bg-white rounded-xl shadow-md p-6 animate-pulse">
          <div class="h-6 bg-gray-200 rounded w-1/4 mb-4"></div>
          <div class="grid grid-cols-2 gap-4">
            <div class="h-20 bg-gray-100 rounded-lg"></div>
            <div class="h-20 bg-gray-100 rounded-lg"></div>
          </div>
        </div>
        <div class="bg-gradient-to-br from-gray-300 to-gray-400 rounded-xl shadow-md p-6 animate-pulse">
          <div class="h-6 bg-white/30 rounded w-1/2 mb-4"></div>
          <div class="h-16 bg-white/30 rounded"></div>
        </div>
      </div>
    </div>
  }
}
