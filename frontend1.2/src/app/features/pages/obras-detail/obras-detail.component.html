<p-toast></p-toast>

@if (loading) {
  <div class="flex justify-center items-center min-h-[60vh]">
    <p-progressSpinner styleClass="w-16 h-16" strokeWidth="4" animationDuration=".8s"></p-progressSpinner>
  </div>
} @else {
  @defer (when obra) {
    <div class="p-6 space-y-6 max-w-5xl mx-auto bg-white rounded-xl shadow-sm">

      <!-- ===================== HEADER ===================== -->
      <div class="flex justify-between items-start flex-wrap gap-3">
        <div>
          <h1 class="text-2xl font-bold text-gray-900">{{ obra.nombre }}</h1>
          <p class="text-gray-500 text-sm mt-1">{{ obra.direccion }}</p>
        </div>
        <div class="flex items-center gap-2">
          <p-button
            icon="pi pi-pencil"
            styleClass="p-button-rounded p-button-text"
            [routerLink]="['/obras/editar', obra.id]"
            pTooltip="Editar"
            tooltipPosition="top">
          </p-button>
        </div>
      </div>

      <!-- ===================== INFO GENERAL ===================== -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="space-y-2">
          <p><strong>Cliente:</strong> {{ obra.cliente.nombre }}</p>
          <div class="flex items-center gap-2">
            <strong>Estado:</strong>
            <p-select
              [options]="estadosObra"
              optionLabel="nombre"
              [ngModel]="obra.obra_estado"
              (ngModelChange)="actualizarEstadoObra($event.id)"
              appendTo="body"
              styleClass="w-48">
            </p-select>
          </div>
          <p><strong>Fecha de inicio:</strong> {{ obra.fecha_inicio | date:'dd/MM/yyyy' }}</p>
          <p><strong>Fecha de fin:</strong> {{ obra.fecha_fin ? (obra.fecha_fin | date:'dd/MM/yyyy') : '‚Äî' }}</p>
        </div>

        <div class="space-y-2">
          <p><strong>Presupuesto:</strong> {{ obra.presupuesto | currency:'ARS' }}</p>
          <p><strong>Gastado:</strong> {{ obra.gastado ?? 0 | currency:'ARS' }}</p>
          <p><strong>Comisi√≥n:</strong> {{ obra.tiene_comision ? (obra.comision + '%') : 'No tiene comisi√≥n' }}</p>
          <div>
            <p class="text-sm text-gray-600 mb-1">Progreso F√≠sico</p>
            <p-progressBar [value]="progresoFisico" [showValue]="true"></p-progressBar>
          </div>
        </div>
      </div>

      <!-- ===================== TABS ===================== -->
      <p-tabs value="0">
        <p-tablist>
          <p-tab value="0">Tareas</p-tab>
          <p-tab value="1">Presupuesto</p-tab>
          <p-tab value="2">Movimientos</p-tab>
          <p-tab value="3">Documentos</p-tab>
        </p-tablist>

        <p-tabpanels>
          <p-tabpanel value="0">
            <app-obra-tareas
              [obraId]="obra.id!"
              [proveedores]="proveedores"
              [tareas]="tareas"
              (tareasActualizadas)="onTareasActualizadas($event)">
            </app-obra-tareas>
          </p-tabpanel>

          <p-tabpanel value="1">
            <app-obra-presupuesto
              [obraId]="obra.id!"
              [proveedores]="proveedores"
              [costos]="obra.costos!"
              [usarBeneficioGlobal]="obra.beneficio_global ?? false"
              [beneficioGlobal]="obra.beneficio ?? 0"
              [tieneComision]="obra.tiene_comision ?? false"
              [comision]="obra.comision ?? 0">
            </app-obra-presupuesto>
          </p-tabpanel>

          <p-tabpanel value="2">
            <app-obra-movimientos [obraId]="obra.id!"></app-obra-movimientos>
          </p-tabpanel>

          <p-tabpanel value="3">
            <app-obra-documentos [obraId]="obra.id!"></app-obra-documentos>
          </p-tabpanel>
        </p-tabpanels>
      </p-tabs>
    </div>
  } @placeholder {
    <!-- ü¶¥ Skeleton Placeholder Obra -->
    <div class="p-6 space-y-6 max-w-5xl mx-auto bg-white rounded-xl shadow-sm animate-pulse">
      <div class="flex justify-between items-start flex-wrap gap-3">
        <div class="space-y-2 w-1/2">
          <div class="h-6 bg-gray-200 rounded w-2/3"></div>
          <div class="h-4 bg-gray-200 rounded w-1/3"></div>
        </div>
        <div class="h-10 w-10 bg-gray-200 rounded-full"></div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="space-y-2">
          <div class="h-4 bg-gray-200 rounded w-2/3"></div>
          <div class="h-4 bg-gray-200 rounded w-1/2"></div>
          <div class="h-4 bg-gray-200 rounded w-1/3"></div>
          <div class="h-4 bg-gray-200 rounded w-1/3"></div>
        </div>
        <div class="space-y-2">
          <div class="h-4 bg-gray-200 rounded w-2/3"></div>
          <div class="h-4 bg-gray-200 rounded w-1/2"></div>
          <div class="h-4 bg-gray-200 rounded w-1/3"></div>
          <div class="h-6 bg-gray-200 rounded w-full"></div>
        </div>
      </div>

      <div class="space-y-3">
        <div class="h-6 bg-gray-200 rounded w-1/4"></div>
        <div class="h-4 bg-gray-200 rounded w-full"></div>
        <div class="h-4 bg-gray-200 rounded w-5/6"></div>
        <div class="h-4 bg-gray-200 rounded w-2/3"></div>
      </div>
    </div>
  }
}
