<p-toast position="bottom-right"></p-toast>
<p-confirmDialog></p-confirmDialog>

@if (loading) {
  <div class="flex justify-center items-center min-h-[60vh]">
    <p-progressSpinner styleClass="w-16 h-16" strokeWidth="4" animationDuration=".8s"></p-progressSpinner>
  </div>
} @else {
  <div class="space-y-6">
    <!-- Resumen financiero de la obra -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-emerald-500 hover:shadow-md transition-shadow">
        <p class="text-xs text-emerald-700 font-semibold uppercase tracking-wide mb-1">Total cobrado</p>
        <p class="text-3xl font-bold text-gray-900">{{ montoCobrado | currency:'ARS':'symbol':'1.0-0' }}</p>
      </div>
      <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-blue-500 hover:shadow-md transition-shadow">
        <p class="text-xs text-blue-700 font-semibold uppercase tracking-wide mb-1">Por cobrar</p>
        <p class="text-3xl font-bold text-gray-900">{{ totalPorCobrar | currency:'ARS':'symbol':'1.0-0' }}</p>
      </div>
      <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-amber-500 hover:shadow-md transition-shadow">
        <p class="text-xs text-amber-700 font-semibold uppercase tracking-wide mb-1">Saldo</p>
        <p class="text-3xl font-bold" [ngClass]="saldoFinal >= 0 ? 'text-gray-900' : 'text-red-600'">
          {{ saldoFinal | currency:'ARS':'symbol':'1.0-0' }}
        </p>
      </div>
      <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-indigo-500 hover:shadow-md transition-shadow">
        <p class="text-xs text-indigo-700 font-semibold uppercase tracking-wide mb-1">Estado</p>
        <p-tag
          [value]="estadoLabel"
          [severity]="estadoLabel === 'Pagada' ? 'danger' : 'warning'"
          styleClass="text-base px-3 py-1 mt-2">
        </p-tag>
      </div>
    </div>

    <!-- Contenido principal -->
    <div class="bg-white rounded-xl shadow-sm">
      <div class="p-6 border-b border-gray-100">
        <div class="flex justify-between items-start">
          <div>
            <h2 class="text-2xl font-bold text-gray-900 mb-1">Factura Nro #{{ factura!.id }}</h2>
          </div>
          <div class="flex gap-2">
            <p-button
              icon="pi pi-download"
              label="Descargar"
              (onClick)="descargarFactura()"
              styleClass="p-button-sm">
            </p-button>
            <p-button
              icon="pi pi-trash"
              label="Eliminar"
              severity="danger"
              [outlined]="true"
              (onClick)="eliminarFactura()"
              styleClass="p-button-sm">
            </p-button>
          </div>
        </div>
      </div>

      <div class="p-6 grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="space-y-4">
          <div>
            <p class="text-xs uppercase text-gray-500 font-semibold mb-2">Cliente</p>
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 rounded-lg bg-emerald-100 flex items-center justify-center flex-shrink-0">
                <i class="pi pi-user text-emerald-600 text-lg"></i>
              </div>
              <p class="text-lg font-semibold text-gray-900">{{ cliente?.nombre || 'Sin cliente' }}</p>
            </div>
          </div>

          <div>
            <p class="text-xs uppercase text-gray-500 font-semibold mb-2">Obra asociada</p>
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 rounded-lg bg-blue-100 flex items-center justify-center flex-shrink-0">
                <i class="pi pi-building text-blue-600 text-lg"></i>
              </div>
              <p class="text-lg font-semibold text-gray-900">{{ obra?.nombre || 'Sin obra' }}</p>
            </div>
          </div>
        </div>

        <div class="space-y-4">
          <div>
            <p class="text-xs uppercase text-gray-500 font-semibold mb-2">Fecha emisi√≥n</p>
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 rounded-lg bg-amber-100 flex items-center justify-center flex-shrink-0">
                <i class="pi pi-calendar text-amber-600 text-lg"></i>
              </div>
              <p class="text-lg font-semibold text-gray-900">{{ factura?.fecha | date:'dd/MM/yyyy' }}</p>
            </div>
          </div>

          <div>
            <p class="text-xs uppercase text-gray-500 font-semibold mb-2">Monto</p>
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 rounded-lg bg-green-100 flex items-center justify-center flex-shrink-0">
                <i class="pi pi-dollar text-green-600 text-lg"></i>
              </div>
              <p class="text-lg font-semibold text-gray-900">{{ factura?.monto | currency:'ARS':'symbol':'1.2-2' }}</p>
            </div>
          </div>
        </div>

        <div>
          <p class="text-xs uppercase text-gray-500 font-semibold mb-2">Archivo adjunto</p>
          <div class="flex items-start gap-3">
            <div class="w-12 h-12 rounded-lg bg-indigo-100 flex items-center justify-center flex-shrink-0">
              <i class="pi pi-file text-indigo-600 text-lg"></i>
            </div>
            <div class="flex-1 min-w-0">
              <p class="text-sm font-medium text-gray-900 truncate">{{ factura?.nombre_archivo || 'Sin archivo' }}</p>
              @if (factura?.nombre_archivo) {
                <p class="text-xs text-gray-500 mt-1">
                  {{ isImageFile(factura!.nombre_archivo) ? 'Imagen' : 'Documento' }}
                </p>
              }
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Vista previa de imagen -->
    @if (previewUrl) {
      <div class="bg-white rounded-xl shadow-sm p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Vista previa del adjunto</h3>
        <div class="flex justify-center">
          <img [src]="previewUrl" alt="Factura adjunta" class="max-w-full max-h-[600px] rounded-lg border border-gray-200 shadow-sm"/>
        </div>
      </div>
    }
  </div>
}
