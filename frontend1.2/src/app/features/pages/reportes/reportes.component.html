<div class="p-6 space-y-6">
  <p-card header="Filtros de búsqueda">
    <form [formGroup]="filtrosForm" (ngSubmit)="applyFilters()" class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
      <div class="flex flex-col gap-2">
        <label class="font-medium text-sm text-gray-700">Obra</label>
        <p-dropdown
          formControlName="obraId"
          [options]="obrasOptions"
          [showClear]="true"
          placeholder="Todas las obras">
        </p-dropdown>
      </div>

      <div class="flex flex-col gap-2">
        <label class="font-medium text-sm text-gray-700">Cliente</label>
        <p-dropdown
          formControlName="clienteId"
          [options]="clientesOptions"
          [showClear]="true"
          placeholder="Todos los clientes">
        </p-dropdown>
      </div>

      <div class="flex flex-col gap-2">
        <label class="font-medium text-sm text-gray-700">Proveedor</label>
        <p-dropdown
          formControlName="proveedorId"
          [options]="proveedoresOptions"
          [showClear]="true"
          placeholder="Todos los proveedores">
        </p-dropdown>
      </div>

      <div class="flex flex-col gap-2">
        <label class="font-medium text-sm text-gray-700">Estados de obra</label>
        <p-multiSelect
          formControlName="estadosObra"
          [options]="estadosObraOptions"
          [filter]="true"
          defaultLabel="Todos los estados"
          display="chip">
        </p-multiSelect>
      </div>

      <div class="flex flex-col gap-2">
        <label class="font-medium text-sm text-gray-700">Rango de fechas</label>
        <p-calendar
          formControlName="rangoFechas"
          selectionMode="range"
          [showIcon]="true"
          dateFormat="dd/mm/yy"
          placeholder="Seleccionar rango">
        </p-calendar>
      </div>

      <div class="flex items-end gap-3">
        <button pButton type="submit" label="Aplicar filtros" icon="pi pi-filter" class="p-button-primary"></button>
        <button pButton type="button" label="Limpiar" icon="pi pi-times" class="p-button-outlined" (click)="clearFilters()"></button>
      </div>
    </form>
  </p-card>

  <div *ngIf="errorMessage" class="rounded-md border border-red-200 bg-red-50 p-4 text-sm text-red-600">
    {{ errorMessage }}
  </div>

  <div class="flex justify-center" *ngIf="loading">
    <p-progressSpinner strokeWidth="4" styleClass="w-12 h-12"></p-progressSpinner>
  </div>

  <div class="space-y-6" *ngIf="!loading">
    <div class="grid gap-4 md:grid-cols-2 xl:grid-cols-4">
      <p-card header="Obras" *ngIf="resumenGeneral">
        <div class="text-3xl font-semibold text-gray-800">{{ resumenGeneral.totalObras }}</div>
        <div class="text-sm text-gray-500">Total de obras registradas</div>
      </p-card>
      <p-card header="Clientes" *ngIf="resumenGeneral">
        <div class="text-3xl font-semibold text-gray-800">{{ resumenGeneral.totalClientes }}</div>
        <div class="text-sm text-gray-500">Clientes activos</div>
      </p-card>
      <p-card header="Proveedores" *ngIf="resumenGeneral">
        <div class="text-3xl font-semibold text-gray-800">{{ resumenGeneral.totalProveedores }}</div>
        <div class="text-sm text-gray-500">Proveedores registrados</div>
      </p-card>
      <p-card header="Saldo neto" *ngIf="resumenGeneral">
        <div class="text-3xl font-semibold text-gray-800">{{ (resumenGeneral.totalIngresos - resumenGeneral.totalEgresos) | currency:'ARS' }}</div>
        <div class="text-sm text-gray-500">Ingresos - Egresos</div>
      </p-card>
    </div>

    <p-card header="Ingresos y egresos por obra" *ngIf="ingresosEgresos">
      <div class="flex flex-wrap gap-6 mb-4 text-sm text-gray-600">
        <span><strong>Total ingresos:</strong> {{ ingresosEgresos.totalIngresos | currency:'ARS' }}</span>
        <span><strong>Total egresos:</strong> {{ ingresosEgresos.totalEgresos | currency:'ARS' }}</span>
      </div>
      <p-table [value]="ingresosEgresos.detallePorObra" [paginator]="true" [rows]="5" [responsiveLayout]="'scroll'" *ngIf="ingresosEgresos.detallePorObra.length; else ingresosEgresosVacio">
        <ng-template pTemplate="header">
          <tr>
            <th>Obra</th>
            <th>Cliente</th>
            <th class="text-right">Ingresos</th>
            <th class="text-right">Egresos</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-item>
          <tr>
            <td>{{ item.obraNombre }}</td>
            <td>{{ item.clienteNombre }}</td>
            <td class="text-right">{{ item.ingresos | currency:'ARS' }}</td>
            <td class="text-right">{{ item.egresos | currency:'ARS' }}</td>
          </tr>
        </ng-template>
      </p-table>
      <ng-template #ingresosEgresosVacio>
        <div class="py-4 text-center text-sm text-gray-500">No hay datos para mostrar.</div>
      </ng-template>
    </p-card>

    <p-card header="Flujo de caja" *ngIf="flujoCaja">
      <div class="flex flex-wrap gap-6 mb-4 text-sm text-gray-600">
        <span><strong>Ingresos:</strong> {{ flujoCaja.totalIngresos | currency:'ARS' }}</span>
        <span><strong>Egresos:</strong> {{ flujoCaja.totalEgresos | currency:'ARS' }}</span>
        <span><strong>Saldo final:</strong> {{ flujoCaja.saldoFinal | currency:'ARS' }}</span>
      </div>
      <p-table [value]="flujoCaja.movimientos" [paginator]="true" [rows]="5" [responsiveLayout]="'scroll'" *ngIf="flujoCaja.movimientos.length; else flujoCajaVacio">
        <ng-template pTemplate="header">
          <tr>
            <th>Fecha</th>
            <th>Tipo</th>
            <th>Obra</th>
            <th>Forma de pago</th>
            <th>Asociado</th>
            <th class="text-right">Monto</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-movimiento>
          <tr>
            <td>{{ movimiento.fecha | date:'dd/MM/yyyy' }}</td>
            <td><p-tag [value]="movimiento.tipo" [severity]="movimiento.tipo === 'INGRESO' ? 'success' : 'danger'"></p-tag></td>
            <td>{{ movimiento.obraNombre }}</td>
            <td>{{ movimiento.formaPago }}</td>
            <td>{{ movimiento.asociadoTipo }} {{ movimiento.asociadoId ? ('#' + movimiento.asociadoId) : '' }}</td>
            <td class="text-right">{{ movimiento.monto | currency:'ARS' }}</td>
          </tr>
        </ng-template>
      </p-table>
      <ng-template #flujoCajaVacio>
        <div class="py-4 text-center text-sm text-gray-500">No hay movimientos en el período seleccionado.</div>
      </ng-template>
    </p-card>

    <div class="grid gap-6 lg:grid-cols-2">
      <p-card header="Pendientes" *ngIf="pendientes">
        <p-table [value]="pendientes.pendientes" [responsiveLayout]="'scroll'" *ngIf="pendientes.pendientes.length; else pendientesVacio">
          <ng-template pTemplate="header">
            <tr>
              <th>Obra</th>
              <th>Proveedor</th>
              <th>Estado</th>
              <th class="text-right">Total</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-item>
            <tr>
              <td>{{ item.obraNombre }}</td>
              <td>{{ item.proveedorNombre }}</td>
              <td>{{ item.estadoPago }}</td>
              <td class="text-right">{{ item.total | currency:'ARS' }}</td>
            </tr>
          </ng-template>
        </p-table>
        <ng-template #pendientesVacio>
          <div class="py-4 text-center text-sm text-gray-500">No hay pagos pendientes.</div>
        </ng-template>
      </p-card>

      <p-card header="Costos por categoría" *ngIf="costosPorCategoria">
        <div class="mb-3 text-sm text-gray-600"><strong>Total:</strong> {{ costosPorCategoria.total | currency:'ARS' }}</div>
        <p-table [value]="costosPorCategoria.categorias" [responsiveLayout]="'scroll'" *ngIf="costosPorCategoria.categorias.length; else costosVacio">
          <ng-template pTemplate="header">
            <tr>
              <th>Categoría</th>
              <th class="text-right">Total</th>
              <th class="text-right">% sobre total</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-item>
            <tr>
              <td>{{ item.categoria }}</td>
              <td class="text-right">{{ item.total | currency:'ARS' }}</td>
              <td class="text-right">{{ item.porcentaje | number:'1.0-2' }}%</td>
            </tr>
          </ng-template>
        </p-table>
        <ng-template #costosVacio>
          <div class="py-4 text-center text-sm text-gray-500">No se registran costos en el período.</div>
        </ng-template>
      </p-card>
    </div>

    <div class="grid gap-6 lg:grid-cols-2">
      <p-card header="Estado de las obras" *ngIf="estadoObras">
        <p-table [value]="estadoObras.obras" [responsiveLayout]="'scroll'" *ngIf="estadoObras.obras.length; else estadoObrasVacio">
          <ng-template pTemplate="header">
            <tr>
              <th>Obra</th>
              <th>Estado</th>
              <th>Cliente</th>
              <th>Inicio</th>
              <th>Fin</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-item>
            <tr>
              <td>{{ item.obraNombre }}</td>
              <td>{{ item.estado }}</td>
              <td>{{ item.clienteNombre }}</td>
              <td>{{ item.fechaInicio | date:'dd/MM/yyyy' }}</td>
              <td>{{ item.fechaFin | date:'dd/MM/yyyy' }}</td>
            </tr>
          </ng-template>
        </p-table>
        <ng-template #estadoObrasVacio>
          <div class="py-4 text-center text-sm text-gray-500">No hay obras para los criterios seleccionados.</div>
        </ng-template>
      </p-card>

      <p-card header="Avance de tareas" *ngIf="avanceTareas">
        <p-table [value]="avanceTareas.avances" [responsiveLayout]="'scroll'" *ngIf="avanceTareas.avances.length; else avanceTareasVacio">
          <ng-template pTemplate="header">
            <tr>
              <th>Obra</th>
              <th>Progreso</th>
              <th>Tareas completadas</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-item>
            <tr>
              <td>{{ item.obraNombre }}</td>
              <td>{{ item.porcentaje | number:'1.0-0' }}%</td>
              <td>{{ item.tareasCompletadas }} / {{ item.totalTareas }}</td>
            </tr>
          </ng-template>
        </p-table>
        <ng-template #avanceTareasVacio>
          <div class="py-4 text-center text-sm text-gray-500">No hay tareas registradas para el período.</div>
        </ng-template>
      </p-card>
    </div>

    <div class="grid gap-6 lg:grid-cols-2">
      <p-card header="Ranking de clientes" *ngIf="rankingClientes">
        <p-table [value]="rankingClientes.clientes" [responsiveLayout]="'scroll'" *ngIf="rankingClientes.clientes.length; else rankingClientesVacio">
          <ng-template pTemplate="header">
            <tr>
              <th>Cliente</th>
              <th class="text-right">Obras</th>
              <th class="text-right">Ingresos</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-item>
            <tr>
              <td>{{ item.clienteNombre }}</td>
              <td class="text-right">{{ item.cantidadObras }}</td>
              <td class="text-right">{{ item.totalIngresos | currency:'ARS' }}</td>
            </tr>
          </ng-template>
        </p-table>
        <ng-template #rankingClientesVacio>
          <div class="py-4 text-center text-sm text-gray-500">No hay información suficiente para el ranking.</div>
        </ng-template>
      </p-card>

      <p-card header="Ranking de proveedores" *ngIf="rankingProveedores">
        <p-table [value]="rankingProveedores.proveedores" [responsiveLayout]="'scroll'" *ngIf="rankingProveedores.proveedores.length; else rankingProveedoresVacio">
          <ng-template pTemplate="header">
            <tr>
              <th>Proveedor</th>
              <th class="text-right">Obras</th>
              <th class="text-right">Costos</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-item>
            <tr>
              <td>{{ item.proveedorNombre }}</td>
              <td class="text-right">{{ item.cantidadObras }}</td>
              <td class="text-right">{{ item.totalCostos | currency:'ARS' }}</td>
            </tr>
          </ng-template>
        </p-table>
        <ng-template #rankingProveedoresVacio>
          <div class="py-4 text-center text-sm text-gray-500">No hay información suficiente para el ranking.</div>
        </ng-template>
      </p-card>
    </div>

    <div class="grid gap-6 lg:grid-cols-2">
      <p-card header="Notas generales">
        <p-table [value]="notasGenerales" [responsiveLayout]="'scroll'" *ngIf="notasGenerales.length; else notasGeneralesVacio">
          <ng-template pTemplate="header">
            <tr>
              <th>Obra</th>
              <th>Estado</th>
              <th>Cliente</th>
              <th>Notas</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-item>
            <tr>
              <td>{{ item.obraNombre }}</td>
              <td>{{ item.estado }}</td>
              <td>{{ item.clienteNombre }}</td>
              <td>{{ item.notas || '-' }}</td>
            </tr>
          </ng-template>
        </p-table>
        <ng-template #notasGeneralesVacio>
          <div class="py-4 text-center text-sm text-gray-500">No hay notas disponibles.</div>
        </ng-template>
      </p-card>

      <p-card header="Detalle de la obra seleccionada" *ngIf="estadoFinancieroObra">
        <div class="space-y-2 text-sm text-gray-700">
          <div><strong>Obra:</strong> {{ estadoFinancieroObra.obraNombre }}</div>
          <div><strong>Cliente:</strong> {{ estadoFinancieroObra.clienteNombre }}</div>
          <div><strong>Estado:</strong> {{ estadoFinancieroObra.estadoObra }}</div>
          <div><strong>Presupuesto:</strong> {{ estadoFinancieroObra.presupuesto | currency:'ARS' }}</div>
          <div><strong>Costos:</strong> {{ estadoFinancieroObra.costos | currency:'ARS' }}</div>
          <div><strong>Cobros:</strong> {{ estadoFinancieroObra.cobros | currency:'ARS' }}</div>
          <div><strong>Pagos:</strong> {{ estadoFinancieroObra.pagos | currency:'ARS' }}</div>
          <div><strong>Utilidad neta:</strong> {{ estadoFinancieroObra.utilidadNeta | currency:'ARS' }}</div>
          <div><strong>Notas:</strong> {{ estadoFinancieroObra.notas || 'Sin notas' }}</div>
        </div>
        <p-divider></p-divider>
        <div *ngIf="notaObraSeleccionada" class="space-y-2 text-sm text-gray-700">
          <div class="font-medium text-gray-800">Notas registradas</div>
          <div><strong>Estado actual:</strong> {{ notaObraSeleccionada.estado }}</div>
          <div><strong>Notas:</strong> {{ notaObraSeleccionada.notas || 'Sin notas registradas' }}</div>
          <div><strong>Inicio:</strong> {{ notaObraSeleccionada.fechaInicio | date:'dd/MM/yyyy' }}</div>
          <div><strong>Fin:</strong> {{ notaObraSeleccionada.fechaFin | date:'dd/MM/yyyy' }}</div>
        </div>
        <div *ngIf="!notaObraSeleccionada" class="text-sm text-gray-500">La obra seleccionada no tiene notas registradas.</div>
      </p-card>
    </div>
  </div>
</div>
