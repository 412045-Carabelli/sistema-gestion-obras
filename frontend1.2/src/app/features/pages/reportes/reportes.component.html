<p-toast position="bottom-right"></p-toast>
<p-confirmDialog></p-confirmDialog>

<div class="p-6 flex flex-col gap-3">

  <p-card header="Filtros de búsqueda" styleClass="min-h-[180px]">
    <form [formGroup]="filtrosForm" (ngSubmit)="applyFilters()" class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
      <div class="flex flex-col gap-2">
        <label class="font-medium text-sm text-gray-700">Obra</label>
        <p-select formControlName="obraId" [options]="obrasOptions" [showClear]="true" placeholder="Todas las obras"></p-select>
      </div>

      <div class="flex flex-col gap-2">
        <label class="font-medium text-sm text-gray-700">Cliente</label>
        <p-select formControlName="clienteId" [options]="clientesOptions" [showClear]="true" placeholder="Todos los clientes"></p-select>
      </div>

      <div class="flex flex-col gap-2">
        <label class="font-medium text-sm text-gray-700">Proveedor</label>
        <p-select formControlName="proveedorId" [options]="proveedoresOptions" [showClear]="true" placeholder="Todos los proveedores"></p-select>
      </div>

      <div class="flex flex-col gap-2">
        <label class="font-medium text-sm text-gray-700">Estados de obra</label>
        <p-multiSelect formControlName="estadosObra" [options]="estadosObraOptions" [filter]="true" defaultLabel="Todos los estados" display="chip"></p-multiSelect>
      </div>

      <div class="flex flex-col gap-2">
        <label class="font-medium text-sm text-gray-700">Rango de fechas</label>
        <p-datePicker formControlName="rangoFechas" selectionMode="range" [showIcon]="true" dateFormat="dd/mm/yy" placeholder="Seleccionar rango"></p-datePicker>
      </div>

      <div class="flex items-end justify-between gap-2">
        <button
          pButton
          type="submit"
          label="Aplicar"
          icon="pi pi-filter"
          class="cursor-pointer p-button-primary text-xs py-1 px-2 h-10"
        ></button>
        <button
          pButton
          type="button"
          label="Limpiar"
          icon="pi pi-times"
          class="cursor-pointer p-button-outlined text-xs py-1 px-2 h-10"
          (click)="clearFilters()"
        ></button>
      </div>

    </form>
  </p-card>

  @if (loading) {
    <div class="flex justify-center">
      <p-progressSpinner strokeWidth="4" styleClass="w-12 h-12"></p-progressSpinner>
    </div>
  } @else {

    <!-- KPIs -->
    <div class="grid gap-4 md:grid-cols-2 xl:grid-cols-4">
      @if (resumenGeneral) {
        <p-card header="Obras" styleClass="min-h-[150px]">
          <div class="text-3xl font-semibold text-gray-800">{{ resumenGeneral.totalObras }}</div>
          <div class="text-sm text-gray-500">Total de obras registradas</div>
        </p-card>
        <p-card header="Clientes" styleClass="min-h-[150px]">
          <div class="text-3xl font-semibold text-gray-800">{{ resumenGeneral.totalClientes }}</div>
          <div class="text-sm text-gray-500">Clientes activos</div>
        </p-card>
        <p-card header="Proveedores" styleClass="min-h-[150px]">
          <div class="text-3xl font-semibold text-gray-800">{{ resumenGeneral.totalProveedores }}</div>
          <div class="text-sm text-gray-500">Proveedores registrados</div>
        </p-card>
        <p-card header="Saldo neto" styleClass="min-h-[150px]">
          <div class="text-3xl font-semibold text-gray-800">
            {{ (resumenGeneral.totalIngresos - resumenGeneral.totalEgresos) | currency:'ARS' }}
          </div>
          <div class="text-sm text-gray-500">Ingresos - Egresos</div>
        </p-card>
      }
    </div>

    <!-- Ingresos/Egresos -->
    @if (ingresosEgresos) {
      <p-card header="Ingresos y egresos por obra" styleClass="min-h-[220px]">
        <div class="flex flex-wrap gap-6 mb-4 text-sm text-gray-600">
          <span><strong>Total ingresos:</strong> {{ ingresosEgresos.totalIngresos | currency:'ARS' }}</span>
          <span><strong>Total egresos:</strong> {{ ingresosEgresos.totalEgresos | currency:'ARS' }}</span>
        </div>

        @if (ingresosEgresos.detallePorObra?.length) {
          <div class="overflow-x-auto">
            <p-table
              [value]="ingresosEgresos.detallePorObra"
              [paginator]="true" [rows]="5"
              responsiveLayout="scroll"
              styleClass="min-w-[720px]">
              <ng-template pTemplate="header">
                <tr>
                  <th>Obra</th>
                  <th>Cliente</th>
                  <th class="text-right">Ingresos</th>
                  <th class="text-right">Egresos</th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-item>
                <tr>
                  <td>{{ item.obraNombre }}</td>
                  <td>{{ item.clienteNombre }}</td>
                  <td class="text-right">{{ item.ingresos | currency:'ARS' }}</td>
                  <td class="text-right">{{ item.egresos | currency:'ARS' }}</td>
                </tr>
              </ng-template>
            </p-table>
          </div>
        } @else {
          <div class="py-4 text-center text-sm text-gray-500">No hay datos para mostrar.</div>
        }
      </p-card>
    }

    <!-- Flujo de caja -->
    @if (flujoCaja) {
      <p-card header="Flujo de caja" styleClass="min-h-[220px]">
        <div class="flex flex-wrap gap-6 mb-4 text-sm text-gray-600">
          <span><strong>Ingresos:</strong> {{ flujoCaja.totalIngresos | currency:'ARS' }}</span>
          <span><strong>Egresos:</strong> {{ flujoCaja.totalEgresos | currency:'ARS' }}</span>
          <span><strong>Saldo final:</strong> {{ flujoCaja.saldoFinal | currency:'ARS' }}</span>
        </div>

        @if (flujoCaja.movimientos?.length) {
          <div class="overflow-x-auto">
            <p-table
              [value]="flujoCaja.movimientos"
              [paginator]="true" [rows]="5"
              responsiveLayout="scroll"
              styleClass="min-w-[880px]">
              <ng-template pTemplate="header">
                <tr>
                  <th>Fecha</th>
                  <th>Tipo</th>
                  <th>Obra</th>
                  <th>Forma de pago</th>
                  <th>Asociado</th>
                  <th class="text-right">Monto</th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-movimiento>
                <tr>
                  <td>{{ movimiento.fecha | date:'dd/MM/yyyy' }}</td>
                  <td><p-tag [value]="movimiento.tipo" [severity]="movimiento.tipo === 'INGRESO' ? 'success' : 'danger'"></p-tag></td>
                  <td>{{ movimiento.obraNombre }}</td>
                  <td>{{ movimiento.formaPago }}</td>
                  <td>{{ movimiento.asociadoTipo }} {{ movimiento.asociadoId ? ('#' + movimiento.asociadoId) : '' }}</td>
                  <td class="text-right">{{ movimiento.monto | currency:'ARS' }}</td>
                </tr>
              </ng-template>
            </p-table>
          </div>
        } @else {
          <div class="py-4 text-center text-sm text-gray-500">No hay movimientos en el período seleccionado.</div>
        }
      </p-card>
    }

    <!-- ... resto de cards igual, solo agregá styleClass="min-h-[220px]" a cada <p-card> -->
  }
</div>
