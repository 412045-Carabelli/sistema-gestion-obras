<p-toast position="bottom-right"></p-toast>
<p-confirmDialog></p-confirmDialog>


<!-- ===================== HEADER CON GRADIENTE ===================== -->
<div class="relative bg-gradient-to-r from-indigo-600 to-purple-800 shadow-lg p-8 text-white overflow-hidden">
  <div class="absolute inset-0 opacity-10">
    <div class="absolute -right-10 -top-10 w-40 h-40 bg-white rounded-full"></div>
    <div class="absolute -left-10 -bottom-10 w-32 h-32 bg-white rounded-full"></div>
  </div>

  <div class="relative z-10">
    <h1 class="text-3xl font-bold mb-2">Reportes</h1>
    <p class="text-indigo-100">Panel de control y análisis detallado de obras</p>
  </div>
</div>

<div class="p-8 space-y-8 max-w-full mx-auto">

  <!-- ===================== FILTROS DE BÚSQUEDA ===================== -->
  <div class="bg-white rounded-xl shadow-md p-6">
    <h2 class="text-lg font-semibold text-gray-900 mb-5 flex items-center gap-2 pb-3 border-b border-gray-200">
      <i class="pi pi-filter text-indigo-600"></i>
      Filtros de búsqueda
    </h2>

    <form [formGroup]="filtrosForm" (ngSubmit)="applyFilters()">
      <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
        <!-- Obra -->
        <div class="flex flex-col">
          <label class="text-sm font-semibold mb-2 text-gray-700 flex items-center gap-2">
            <i class="pi pi-building text-gray-400 text-xs"></i>
            Obra
          </label>
          <p-select
            formControlName="obraId"
            [options]="obrasOptions"
            [showClear]="true"
            placeholder="Todas las obras"
            styleClass="w-full"
          ></p-select>
        </div>

        <!-- Cliente -->
        <div class="flex flex-col">
          <label class="text-sm font-semibold mb-2 text-gray-700 flex items-center gap-2">
            <i class="pi pi-user text-gray-400 text-xs"></i>
            Cliente
          </label>
          <p-select
            formControlName="clienteId"
            [options]="clientesOptions"
            [showClear]="true"
            placeholder="Todos los clientes"
            styleClass="w-full"
          ></p-select>
        </div>

        <!-- Proveedor -->
        <div class="flex flex-col">
          <label class="text-sm font-semibold mb-2 text-gray-700 flex items-center gap-2">
            <i class="pi pi-users text-gray-400 text-xs"></i>
            Proveedor
          </label>
          <p-select
            formControlName="proveedorId"
            [options]="proveedoresOptions"
            [showClear]="true"
            placeholder="Todos los proveedores"
            styleClass="w-full"
          ></p-select>
        </div>

        <!-- Estados de obra -->
        <div class="flex flex-col">
          <label class="text-sm font-semibold mb-2 text-gray-700 flex items-center gap-2">
            <i class="pi pi-flag text-gray-400 text-xs"></i>
            Estados de obra
          </label>
          <p-multiSelect
            formControlName="estadosObra"
            [options]="estadosObraOptions"
            optionLabel="label"
            optionValue="name"
            [filter]="true"
            defaultLabel="Todos los estados"
            display="chip"
            styleClass="w-full"
          ></p-multiSelect>
        </div>

        <!-- Rango de fechas -->
        <div class="flex flex-col">
          <label class="text-sm font-semibold mb-2 text-gray-700 flex items-center gap-2">
            <i class="pi pi-calendar text-gray-400 text-xs"></i>
            Rango de fechas
          </label>
          <p-datePicker
            formControlName="rangoFechas"
            selectionMode="range"
            [showIcon]="true"
            dateFormat="dd/mm/yy"
            placeholder="Seleccionar rango"
            styleClass="w-full"
          ></p-datePicker>
        </div>

        <!-- Botones -->
        <div class="grid grid-cols-2 items-end gap-3">
          <p-button
            type="submit"
            label="Aplicar"
            icon="pi pi-filter"
          ></p-button>
          <p-button
            type="button"
            label="Limpiar"
            icon="pi pi-times"
            [outlined]="true"
            severity="secondary"
            (click)="clearFilters()"
          ></p-button>
        </div>
      </div>
    </form>
  </div>

  <!-- ===================== LOADING ===================== -->
  @if (loading) {
    <div class="flex justify-center items-center py-12">
      <p-progressSpinner strokeWidth="4" styleClass="w-16 h-16"></p-progressSpinner>
    </div>
  } @else {

    <!-- ===================== INGRESOS Y EGRESOS ===================== -->
    @if (ingresosEgresos) {
      <div class="bg-white rounded-xl shadow-md p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-5 flex items-center gap-2 pb-3 border-b border-gray-200">
          <i class="pi pi-chart-bar text-indigo-600"></i>
          Ingresos y egresos por obra
        </h2>

        <div class="flex flex-wrap gap-6 mb-6">
          <div class="flex items-center gap-2">
            <div class="w-3 h-3 bg-green-500 rounded-full"></div>
            <span class="text-sm text-gray-600">
              <strong>Total ingresos:</strong> {{ ingresosEgresos.totalIngresos | currency:'ARS':'symbol-narrow':'1.0-0' }}
            </span>
          </div>
          <div class="flex items-center gap-2">
            <div class="w-3 h-3 bg-red-500 rounded-full"></div>
            <span class="text-sm text-gray-600">
              <strong>Total egresos:</strong> {{ ingresosEgresos.totalEgresos | currency:'ARS':'symbol-narrow':'1.0-0' }}
            </span>
          </div>
        </div>

        @if (ingresosEgresos.detallePorObra?.length) {
          <div class="overflow-x-auto">
            <p-table
              [value]="ingresosEgresos.detallePorObra"
              [paginator]="true"
              [rows]="5"
              responsiveLayout="scroll"
              styleClass="p-datatable-sm">
              <ng-template pTemplate="header">
                <tr>
                  <th>Obra</th>
                  <th>Cliente</th>
                  <th class="text-right">Ingresos</th>
                  <th class="text-right">Egresos</th>
                  <th class="text-right">Balance</th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-item>
                <tr>
                  <td><strong>{{ item.obraNombre }}</strong></td>
                  <td>{{ item.clienteNombre }}</td>
                  <td class="text-right text-green-600 font-semibold">{{ item.ingresos | currency:'ARS':'symbol-narrow':'1.0-0' }}</td>
                  <td class="text-right text-red-600 font-semibold">{{ item.egresos | currency:'ARS':'symbol-narrow':'1.0-0' }}</td>
                  <td class="text-right font-bold" [ngClass]="item.ingresos - item.egresos >= 0 ? 'text-green-600' : 'text-red-600'">
                    {{ (item.ingresos - item.egresos) | currency:'ARS':'symbol-narrow':'1.0-0' }}
                  </td>
                </tr>
              </ng-template>
            </p-table>
          </div>
        } @else {
          <div class="flex flex-col items-center justify-center py-12 text-gray-400">
            <i class="pi pi-chart-bar text-5xl mb-3"></i>
            <p class="text-lg font-medium text-gray-500">No hay datos para mostrar</p>
            <p class="text-sm text-gray-400">Ajusta los filtros para ver información</p>
          </div>
        }
      </div>
    }

    <!-- ===================== FLUJO DE CAJA ===================== -->
    @if (flujoCaja) {
      <div class="bg-white rounded-xl shadow-md p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-5 flex items-center gap-2 pb-3 border-b border-gray-200">
          <i class="pi pi-wallet text-indigo-600"></i>
          Flujo de caja
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <div class="bg-green-50 rounded-lg p-4 border border-green-200">
            <div class="flex items-center gap-2 mb-2">
              <i class="pi pi-arrow-up text-green-600"></i>
              <span class="text-sm font-medium text-gray-600">Ingresos</span>
            </div>
            <div class="text-2xl font-bold text-green-600">
              {{ flujoCaja.totalIngresos | currency:'ARS':'symbol-narrow':'1.0-0' }}
            </div>
          </div>

          <div class="bg-red-50 rounded-lg p-4 border border-red-200">
            <div class="flex items-center gap-2 mb-2">
              <i class="pi pi-arrow-down text-red-600"></i>
              <span class="text-sm font-medium text-gray-600">Egresos</span>
            </div>
            <div class="text-2xl font-bold text-red-600">
              {{ flujoCaja.totalEgresos | currency:'ARS':'symbol-narrow':'1.0-0' }}
            </div>
          </div>

          <div class="bg-indigo-50 rounded-lg p-4 border border-indigo-200">
            <div class="flex items-center gap-2 mb-2">
              <i class="pi pi-wallet text-indigo-600"></i>
              <span class="text-sm font-medium text-gray-600">Saldo final</span>
            </div>
            <div class="text-2xl font-bold" [ngClass]="flujoCaja.saldoFinal >= 0 ? 'text-indigo-600' : 'text-red-600'">
              {{ flujoCaja.saldoFinal | currency:'ARS':'symbol-narrow':'1.0-0' }}
            </div>
          </div>
        </div>

        @if (flujoCaja.movimientos?.length) {
          <div class="overflow-x-auto">
            <p-table
              [value]="flujoCaja.movimientos"
              [paginator]="true"
              [rows]="5"
              responsiveLayout="scroll"
              styleClass="p-datatable-sm">
              <ng-template pTemplate="header">
                <tr>
                  <th>Fecha</th>
                  <th>Tipo</th>
                  <th>Obra</th>
                  <th>Forma de pago</th>
                  <th>Asociado</th>
                  <th class="text-right">Monto</th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-movimiento>
                <tr>
                  <td>{{ movimiento.fecha | date:'dd/MM/yyyy' }}</td>
                  <td>
                    <p-tag
                      [value]="movimiento.tipo"
                      [severity]="movimiento.tipo === 'COBRO' ? 'success' : 'danger'"
                    ></p-tag>
                  </td>
                  <td><strong>{{ movimiento.obraNombre }}</strong></td>
                  <td>{{ movimiento.formaPago }}</td>
                  <td>{{ nombreAsociado(movimiento.asociadoTipo, movimiento.asociadoId) }}</td>
                  <td class="text-right font-semibold" [ngClass]="movimiento.tipo === 'COBRO' ? 'text-green-600' : 'text-red-600'">
                    {{ movimiento.tipo === 'COBRO' ? '+' : '-' }} {{ movimiento.monto | currency:'ARS':'symbol-narrow':'1.0-0' }}
                  </td>
                </tr>
              </ng-template>
            </p-table>
          </div>
        } @else {
          <div class="flex flex-col items-center justify-center py-12 text-gray-400">
            <i class="pi pi-wallet text-5xl mb-3"></i>
            <p class="text-lg font-medium text-gray-500">No hay movimientos</p>
            <p class="text-sm text-gray-400">No hay movimientos en el período seleccionado</p>
          </div>
        }
      </div>
    }

    <!-- ===================== CUENTA CORRIENTE POR OBRA ===================== -->
    @if (cuentaCorrienteObra) {
      <div class="bg-white rounded-xl shadow-md p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-5 flex items-center gap-2 pb-3 border-b border-gray-200">
          <i class="pi pi-briefcase text-indigo-600"></i>
          Cuenta corriente por obra
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 text-sm">
          <div class="bg-green-50 border border-green-200 rounded-lg p-3">
            <p class="text-gray-600">Total ingresos</p>
            <p class="text-2xl font-bold text-green-600">{{ cuentaCorrienteObra.totalIngresos | currency:'ARS':'symbol-narrow':'1.0-0' }}</p>
          </div>
          <div class="bg-red-50 border border-red-200 rounded-lg p-3">
            <p class="text-gray-600">Total egresos</p>
            <p class="text-2xl font-bold text-red-600">{{ cuentaCorrienteObra.totalEgresos | currency:'ARS':'symbol-narrow':'1.0-0' }}</p>
          </div>
          <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-3">
            <p class="text-gray-600">Saldo final</p>
            <p class="text-2xl font-bold text-indigo-700">{{ saldoSinNegativo(cuentaCorrienteObra.saldoFinal) | currency:'ARS':'symbol-narrow':'1.0-0' }}</p>
          </div>
        </div>

        @if (cuentaCorrienteObra.movimientos?.length) {
          <p-table [value]="cuentaCorrienteObra.movimientos" [paginator]="true" [rows]="5" responsiveLayout="scroll" styleClass="p-datatable-sm">
            <ng-template pTemplate="header">
              <tr>
                <th>Fecha</th>
                <th>Obra</th>
                <th>Concepto</th>
                <th>Tipo</th>
                <th>Asociado</th>
                <th class="text-right">Monto</th>
                <th class="text-right">Cobros acum.</th>
                <th class="text-right">Costos acum.</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-item>
              <tr>
                <td>{{ item.fecha | date:'dd/MM/yyyy' }}</td>
                <td>{{ item.obraNombre || cuentaCorrienteObra?.obraNombre || '-' }}</td>
                <td>{{ item.concepto || item.referencia || '-' }}</td>
                <td>
                  <p-tag [value]="item.tipo" [severity]="item.tipo === 'COBRO' ? 'success' : item.tipo === 'COSTO' ? 'danger' : 'info'"></p-tag>
                </td>
                <td>{{ item.asociadoNombre || nombreAsociado(item.asociadoTipo, item.asociadoId) }}</td>
                <td class="text-right">{{ item.monto | currency:'ARS':'symbol-narrow':'1.0-0' }}</td>
                <td class="text-right">{{ item.cobrosAcumulados ?? item.ingresosAcumulados ?? 0 | currency:'ARS':'symbol-narrow':'1.0-0' }}</td>
                <td class="text-right">{{ item.costosAcumulados ?? item.egresosAcumulados ?? 0 | currency:'ARS':'symbol-narrow':'1.0-0' }}</td>
              </tr>
            </ng-template>
          </p-table>
        } @else {
          <p class="text-gray-500">No hay movimientos para la obra seleccionada.</p>
        }
      </div>
    }

    <!-- ===================== CUENTA CORRIENTE POR CLIENTE ===================== -->
    @if (cuentaCorrienteCliente) {
      <div class="bg-white rounded-xl shadow-md p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-5 flex items-center gap-2 pb-3 border-b border-gray-200">
          <i class="pi pi-user text-indigo-600"></i>
          Cuenta corriente por cliente
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 text-sm">
          <div class="bg-green-50 border border-green-200 rounded-lg p-3">
            <p class="text-gray-600">Cobros</p>
            <p class="text-2xl font-bold text-green-600">{{ cuentaCorrienteCliente.totalCobros | currency:'ARS':'symbol-narrow':'1.0-0' }}</p>
          </div>
          <div class="bg-red-50 border border-red-200 rounded-lg p-3">
            <p class="text-gray-600">Costos</p>
            <p class="text-2xl font-bold text-red-600">{{ cuentaCorrienteCliente.totalCostos | currency:'ARS':'symbol-narrow':'1.0-0' }}</p>
          </div>
          <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-3">
            <p class="text-gray-600">Saldo final</p>
            <p class="text-2xl font-bold text-indigo-700">{{ saldoSinNegativo(cuentaCorrienteCliente.saldoFinal) | currency:'ARS':'symbol-narrow':'1.0-0' }}</p>
          </div>
        </div>

        @if (cuentaCorrienteCliente.movimientos?.length) {
          <p-table [value]="cuentaCorrienteCliente.movimientos" [paginator]="true" [rows]="5" responsiveLayout="scroll" styleClass="p-datatable-sm">
            <ng-template pTemplate="header">
              <tr>
                <th>Fecha</th>
                <th>Obra</th>
                <th>Concepto</th>
                <th>Tipo</th>
                <th>Asociado</th>
                <th class="text-right">Monto</th>
                <th class="text-right">Cobros acum.</th>
                <th class="text-right">Costos acum.</th>
                <th class="text-right">Saldo</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-item>
              <tr>
                <td>{{ item.fecha | date:'dd/MM/yyyy' }}</td>
                <td>{{ item.obraNombre || '-' }}</td>
                <td>{{ item.concepto || item.referencia || '-' }}</td>
                <td>
                  <p-tag [value]="item.tipo" [severity]="item.tipo === 'COBRO' ? 'success' : item.tipo === 'COSTO' ? 'danger' : 'info'"></p-tag>
                </td>
                <td>{{ item.asociadoNombre || nombreAsociado(item.asociadoTipo, item.asociadoId) }}</td>
                <td class="text-right">{{ item.monto | currency:'ARS':'symbol-narrow':'1.0-0' }}</td>
                <td class="text-right">{{ item.cobrosAcumulados ?? 0 | currency:'ARS':'symbol-narrow':'1.0-0' }}</td>
                <td class="text-right">{{ item.costosAcumulados ?? 0 | currency:'ARS':'symbol-narrow':'1.0-0' }}</td>
                <td class="text-right">{{ saldoSinNegativo(item.saldoCliente) | currency:'ARS':'symbol-narrow':'1.0-0' }}</td>
              </tr>
            </ng-template>
          </p-table>
        } @else {
          <p class="text-gray-500">No hay movimientos para el cliente filtrado.</p>
        }
      </div>
    }

    <!-- ===================== CUENTA CORRIENTE POR PROVEEDOR ===================== -->
    @if (cuentaCorrienteProveedor) {
      <div class="bg-white rounded-xl shadow-md p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-5 flex items-center gap-2 pb-3 border-b border-gray-200">
          <i class="pi pi-truck text-indigo-600"></i>
          Cuenta corriente por proveedor
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 text-sm">
          <div class="bg-amber-50 border border-amber-200 rounded-lg p-3">
            <p class="text-gray-600">Costos</p>
            <p class="text-2xl font-bold text-amber-700">{{ cuentaCorrienteProveedor.totalCostos | currency:'ARS':'symbol-narrow':'1.0-0' }}</p>
          </div>
          <div class="bg-green-50 border border-green-200 rounded-lg p-3">
            <p class="text-gray-600">Pagos</p>
            <p class="text-2xl font-bold text-green-700">{{ cuentaCorrienteProveedor.totalPagos | currency:'ARS':'symbol-narrow':'1.0-0' }}</p>
          </div>
          <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-3">
            <p class="text-gray-600">Saldo proveedor</p>
            <p class="text-2xl font-bold text-indigo-700">{{ saldoSinNegativo(cuentaCorrienteProveedor.saldoFinal) | currency:'ARS':'symbol-narrow':'1.0-0' }}</p>
          </div>
        </div>

        @if (cuentaCorrienteProveedor.movimientos?.length) {
          <p-table [value]="cuentaCorrienteProveedor.movimientos" [paginator]="true" [rows]="5" responsiveLayout="scroll" styleClass="p-datatable-sm">
            <ng-template pTemplate="header">
              <tr>
                <th>Fecha</th>
                <th>Obra</th>
                <th>Concepto</th>
                <th>Tipo</th>
                <th class="text-right">Monto</th>
                <th class="text-right">Costos acum.</th>
                <th class="text-right">Pagos acum.</th>
                <th class="text-right">Saldo proveedor</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-item>
              <tr>
                <td>{{ item.fecha | date:'dd/MM/yyyy' }}</td>
                <td>{{ item.obraNombre || (item.obraId ? ('Obra #' + item.obraId) : '-') }}</td>
                <td>{{ item.concepto || '-' }}</td>
                <td>
                  <p-tag [value]="item.tipo" [severity]="item.tipo === 'PAGO' ? 'success' : 'danger'"></p-tag>
                </td>
                <td class="text-right">{{ item.monto | currency:'ARS':'symbol-narrow':'1.0-0' }}</td>
                <td class="text-right">{{ item.costosAcumulados || 0 | currency:'ARS':'symbol-narrow':'1.0-0' }}</td>
                <td class="text-right">{{ item.pagosAcumulados || 0 | currency:'ARS':'symbol-narrow':'1.0-0' }}</td>
                <td class="text-right">{{ saldoSinNegativo(item.saldoProveedor) | currency:'ARS':'symbol-narrow':'1.0-0' }}</td>
              </tr>
            </ng-template>
          </p-table>
        } @else {
          <p class="text-gray-500">No hay movimientos para el proveedor filtrado.</p>
        }
      </div>
    }

    <!-- ===================== COMISIONES ===================== -->
    @if (comisiones) {
      <div class="bg-white rounded-xl shadow-md p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-5 flex items-center gap-2 pb-3 border-b border-gray-200">
          <i class="pi pi-percentage text-indigo-600"></i>
          Comisiones
        </h2>

        <div class="flex items-center gap-3 mb-4 text-sm">
          <span class="text-gray-600">Total comisiones:</span>
          <span class="text-xl font-bold text-indigo-700">{{ comisiones.totalComision | currency:'ARS':'symbol-narrow':'1.0-0' }}</span>
          <span class="text-gray-500">| Saldo:</span>
          <span class="font-semibold text-slate-800">{{ comisiones.saldo | currency:'ARS':'symbol-narrow':'1.0-0' }}</span>
        </div>

        @if (comisiones.detalle?.length) {
          <p-table [value]="comisiones.detalle" [paginator]="true" [rows]="5" responsiveLayout="scroll" styleClass="p-datatable-sm">
            <ng-template pTemplate="header">
              <tr>
                <th>Obra</th>
                <th class="text-right">Monto</th>
                <th class="text-right">Saldo</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-item>
              <tr>
                <td>{{ item.obraNombre || 'General' }}</td>
                <td class="text-right">{{ item.monto | currency:'ARS':'symbol-narrow':'1.0-0' }}</td>
                <td class="text-right text-slate-800">{{ item.saldo | currency:'ARS':'symbol-narrow':'1.0-0' }}</td>
              </tr>
            </ng-template>
          </p-table>
        } @else {
          <p class="text-gray-500">No hay comisiones registradas para los filtros seleccionados.</p>
        }
      </div>
    }

  }
</div>
